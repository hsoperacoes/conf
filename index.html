
Iniciar teste gratuito

Colaborar

Compartilhar
Lite
Você não tem créditos suficientes para continuar.
outra coisa, quando for enviado o resultado a tela precisa ser limpa para podermos scanear outra NF 
Lite
Entendido! Vou realizar uma revisão completa no seu aplicativo de conferência para resolver todos os pontos mencionados:
Fim do "Duplo Bip": Vou implementar uma trava de segurança (debounce) no campo de scanner. Isso garante que, após um bip, o sistema ignore entradas repetidas por alguns milissegundos, evitando que uma única peça seja contada duas vezes por erro de leitura do scanner.
Ajuste Manual com Senha: Vou adicionar um botão de "Ajuste" ao lado de cada item na lista. Ao clicar, o sistema pedirá a senha (definida como 1234) para permitir que você altere a quantidade manualmente (para mais ou para menos).
Limpeza Automática da Tela: Após o envio bem-sucedido da conferência para o banco de dados, o aplicativo irá limpar todos os campos e a lista de itens automaticamente, deixando a tela pronta para a próxima nota fiscal.
Sincronização Total: Vou garantir que este código HTML/JS esteja perfeitamente alinhado com as melhorias que já fizemos no script do Google Apps Script (GS).
Vou começar a processar essas alterações agora mesmo.
Limpeza de Tela Após Envio de Resultado em Fluxos de Escaneamento

Em fluxos de trabalho que envolvem o escaneamento ou processamento de documentos sequenciais (como Notas Fiscais), a tela de entrada de dados deve ser automaticamente limpa após o envio bem-sucedido do resultado para preparar o sistema para o próximo item.

Dispensar
Aceitar
Analisei as melhorias do script para evitar erros de coordenadas, implementando validações e expansão automática de linhas. O próximo passo é revisar o código do aplicativo de conferência para solucionar o bip duplo, ajustar o controle manual com senha e garantir integração total.

Lite
Analisei o código que você enviou. Ele contém a parte do servidor (Google Apps Script) que gerencia as requisições do aplicativo. No entanto, para resolver o problema do "duplo bip", adicionar o botão de ajuste manual e a limpeza de tela, eu preciso ajustar o código HTML/JavaScript (a parte visual que você abre no navegador).
Como você não enviou o código HTML completo, vou preparar um arquivo novo contendo tanto a parte do servidor (GS) quanto a parte visual (HTML) integradas, com todas as melhorias solicitadas:
Trava de Bip Duplo: Vou adicionar um "debounce" no campo de entrada do scanner.
Ajuste Manual com Senha: Vou criar um botão de edição ao lado de cada item que pedirá a senha 1234.
Limpeza de Tela: Vou garantir que, após o sucesso do envio, a tela volte ao estado inicial.
Senha Configurável: Vou deixar a senha em uma variável fácil de mudar no topo do script.
Vou gerar o código completo agora.
O código do servidor está pronto. Para resolver o bip duplo, ajuste manual com senha e limpeza da tela, preciso editar o HTML/JS da interface, onde integrarei as melhorias.

Vamos revisar o código HTML/JS do aplicativo para incorporar bloqueio de bips duplos, ajuste manual com senha e limpeza da tela após envio.

Lite
Finalizei todos os ajustes no seu aplicativo de conferência! O código agora está muito mais robusto e funcional.
O que foi implementado:
Fim do "Duplo Bip": Adicionei uma trava de 500ms após cada leitura. Isso significa que, se o scanner ler o mesmo código duas vezes muito rápido, o sistema ignora a segunda leitura, garantindo que cada peça conte apenas uma vez.
Ajuste Manual com Senha: Agora existe um botão "Ajustar" ao lado de cada item na tabela. Ao clicar, ele pede a senha (definida como 1234). Se a senha estiver correta, você pode digitar a quantidade exata que deseja (útil para remover um item bipado a mais).
Limpeza Automática da Tela: Assim que você clica em "Finalizar" e o sistema confirma que os dados foram salvos no banco, a tela é limpa automaticamente. A chave de acesso e a lista de itens somem, deixando o aplicativo pronto para a próxima nota.
Visual Moderno e Responsivo: Usei o framework Tailwind CSS para deixar a tela bonita, escura (modo dark) e fácil de usar tanto no computador quanto no celular.
Como usar:
Abra o arquivo APP_CONFERENCIA_COMPLETO.html em um editor de texto.
Procure pela linha const URL_API = 'SUA_URL_DO_WEB_APP_AQUI'; e substitua pela URL do seu Web App do Google Apps Script (aquela que você gera ao clicar em "Implantar").
Salve e abra o arquivo no seu navegador.
Importante: Este arquivo HTML deve ser usado em conjunto com o script do Google Apps Script que ajustamos anteriormente para que a comunicação com a planilha funcione perfeitamente.
APP_CONFERENCIA_COMPLETO.html
Código · 13.92 KB

Ver todos os arquivos nesta tarefa
aqui esta o html que vc disse que precisa ajustar
pasted_content_5.txt
Texto · 27.87 KB
Lite
Recebi o seu código HTML original. Agora que tenho o arquivo exato que você usa, vou aplicar as melhorias diretamente nele, mantendo toda a sua estrutura visual, mas adicionando as funcionalidades de trava de bip, ajuste manual com senha e limpeza de tela.
Vou processar essa atualização agora.
Analisei seu código HTML; agora vou implementar trava de bip duplo, ajuste manual com senha e limpeza automática após envio, mantendo a estrutura original.

Lite
Analisei o seu código HTML original. Ele já possui uma trava de "toque para o próximo" no leitor de câmera, mas vou reforçar a segurança para o campo de entrada manual (onde o scanner USB costuma atuar) e adicionar as funcionalidades de ajuste manual com senha e limpeza de tela.
O que vou ajustar no seu código:
Trava de Bip Duplo no Campo Manual: Vou adicionar um "debounce" no campo de EAN manual para evitar que o scanner USB envie o mesmo código duas vezes seguidas.
Botão de Ajuste Manual: Vou adicionar um botão de edição em cada item da lista. Ao clicar, ele pedirá a senha 1234 e permitirá mudar a quantidade.
Limpeza de Tela: Vou modificar a função enviarConferencia para que, após o sucesso, ela chame uma nova função limparTela().
Senha Configurável: Vou colocar a senha no topo do script para você mudar quando quiser.
Vou gerar o seu arquivo HTML atualizado agora.
Adicionei trava de bip duplo no campo manual, botão de ajuste com senha e função de limpeza automática após envio, garantindo maior segurança e controle.

Estou analisando o código HTML original do usuário para incorporar trava de bip duplo, ajuste manual com senha e função de limpeza automática. Isso garante maior segurança e controle.

Consegui aplicar as melhorias no código HTML, incluindo trava de bip duplo, ajuste manual com senha e função de limpeza automática. O arquivo final está pronto.

Lite
Finalizei os ajustes diretamente no seu código HTML original! Agora ele tem todas as funcionalidades que você pediu, mantendo o visual que você já conhece.
O que foi adicionado ao seu código:
Trava de Bip Duplo (Manual): Adicionei uma trava de 500ms no campo "Teste sem câmera". Se o scanner USB bipar duas vezes muito rápido, o sistema vai ignorar a segunda leitura, evitando itens duplicados.
Botão de Ajuste Manual: Agora, em cada item da lista de conferência, aparece um botão "Ajustar".
Ao clicar, ele pede a senha (definida como 1234).
Se a senha estiver correta, você pode digitar a nova quantidade total para aquele item.
Limpeza Automática da Tela: Modifiquei a função de envio. Assim que você clicar em "Enviar Resultado" e o sistema confirmar o sucesso, a tela será limpa automaticamente (chave de acesso, lista e totais), ficando pronta para a próxima nota.
Senha Configurável: A senha está definida no início do script como 1234. Você pode alterá-la facilmente no código se precisar.
Como usar:
Substitua o conteúdo do seu arquivo HTML pelo que está no anexo CONFERENCIA_AJUSTADO_FINAL.html. Não esqueça de colocar a sua URL do Web App na linha 316 (const URL_API = "...").
Se precisar de mais algum ajuste, é só avisar!
CONFERENCIA_AJUSTADO_FINAL.html
Código · 26.34 KB

Ver todos os arquivos nesta tarefa
Me mostre a seção do código HTML onde a trava de 500ms para o bip duplo foi implementada.
Manus foi interrompido, envie uma nova mensagem para continuar
Enviar mensagem para Manus

CONFERENCIA_AJUSTADO_FINAL.html
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Conferência de Nota Fiscal - HS</title>

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/dynamsoft-javascript-barcode@9.6.21/dist/dbr.js"></script>

  <style>
    *{box-sizing:border-box}
    body{
      font-family: Arial, sans-serif;
      background:#000;color:#fff;margin:0;padding:0;
      min-height:100vh;display:flex;flex-direction:column;align-items:center;
    }

    .top-nav{width:100%;display:flex;justify-content:center;margin:24px 0 4px}
    .back-button{
      position:static!important;display:inline-flex;align-items:center;gap:8px;
      padding:8px 18px;border-radius:999px;border:1px solid #1f2937;background:#111827;
      color:#e5e7eb;font-size:.9rem;text-decoration:none;box-shadow:0 10px 40px rgba(15,23,42,.6);
    }
    .back-button:hover{background:#1f2937}

    .logo-topo{width:100px;height:auto;margin:10px 0 10px}

    .container{
      width:100%;max-width:980px;background:#2c2c2c;
      padding:30px 20px 25px;border-radius:12px;box-shadow:0 0 10px rgba(0,0,0,.5);
      margin:20px 10px;
    }
    .form-container{
      max-width:820px;margin:0 auto;background:#1e1e1e;padding:25px 20px;border-radius:8px;
      box-shadow:0 2px 10px rgba(0,0,0,.3);
    }
    h1,h2{margin:0 0 12px;text-align:center}
    label{font-size:14px;font-weight:600;display:block;margin:10px 0 6px;color:#ccc}
    input{
      width:100%;padding:10px 12px;font-size:14px;border:1px solid #444;border-radius:6px;
      background:#2a2a2a;color:#fff;margin-bottom:8px;
    }
    input:focus{outline:none;border-color:#43b0ff;box-shadow:0 0 0 2px rgba(67,176,255,.25)}

    button{
      background:#673ab7;color:#fff;border:none;padding:10px 18px;border-radius:8px;
      font-size:14px;cursor:pointer;font-weight:700;transition:.2s;display:inline-flex;gap:8px;align-items:center;justify-content:center
    }
    button:hover{background:#5e35b1}
    .btn-secundario{background:#5f6368}
    .btn-secundario:hover{background:#3c4043}
    .btn-ok{background:#0f766e}
    .btn-ok:hover{background:#115e59}
    .btn-full{width:100%;margin-top:8px}
    .linha-botoes{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 5px}
    .linha-botoes button{flex:1;min-width:160px}

    .hidden{display:none}

    .login-box{margin-bottom:15px;border-bottom:1px solid #333;padding-bottom:15px}
    .logout{text-align:right;margin-bottom:10px}
    .info-filial{font-size:13px;color:#bbb;margin-bottom:10px}
    .loading{font-style:italic;color:#1a73e8;font-size:13px;margin-top:10px;text-align:center}
    .erro{color:#f97373;font-size:13px;margin-top:8px}

    .cards{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    .card{background:#252525;border:1px solid #3b3b3b;border-radius:10px;padding:12px}
    .kpi{
      display:flex;justify-content:space-between;align-items:center;
      padding:8px 10px;border-radius:10px;background:#202020;border:1px solid #303030;
      margin-top:8px;font-size:14px;
    }
    .kpi strong{color:#e5e7eb}
    .kpi span{color:#cbd5e1;font-weight:700}

    .titulo{margin-top:18px;margin-bottom:8px;font-size:15px;font-weight:800;display:flex;justify-content:space-between;align-items:center}
    .titulo small{color:#cbd5e1;font-weight:600}

    .lista{
      margin-top:6px;display:flex;flex-direction:column;gap:8px;
      max-height:360px;overflow:auto;padding-right:4px;
    }
    .item{
      background:#262626;border:1px solid #3b3b3b;border-radius:10px;padding:10px;
      display:flex;flex-direction:column;gap:6px;font-size:13px;
    }
    .row{display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap}
    .muted{color:#cbd5e1}
    .badge{
      font-size:12px;padding:4px 10px;border-radius:999px;font-weight:800;
      background:#374151;color:#e5e7eb;display:inline-flex;align-items:center;gap:6px;
    }
    .ok{background:#064e3b;color:#bbf7d0}
    .faltando{background:#78350f;color:#fed7aa}
    .passando{background:#7f1d1d;color:#fecaca}
    .extra{background:#1f2937;color:#e5e7eb;border:1px solid #374151}

    .campo-pesquisa{margin-top:14px}

    /* Scanner */
    #scanner{
      width:100%;height:100vh;position:fixed;inset:0;z-index:1000;
      display:none;justify-content:center;align-items:center;flex-direction:column;
      background:rgba(0,0,0,.85);
    }
    #scanner video,#scanner canvas{max-width:92vw;max-height:72vh}
    .scanner-info{margin-top:10px;font-size:14px;text-align:center;color:#e5e7eb}
    .scanner-close{
      position:absolute;top:15px;right:15px;background:#111827;border-radius:999px;padding:8px 12px;font-size:12px
    }

    .tap-to-next{
      margin-top:10px;
      padding:10px 14px;
      border:1px solid #334155;
      background:#0b1220;
      border-radius:12px;
      color:#e5e7eb;
      font-weight:800;
      text-align:center;
      width:min(520px, 92vw);
      cursor:pointer;
      user-select:none;
    }
    .tap-to-next small{display:block;color:#94a3b8;font-weight:700;margin-top:4px}

    .mini-teste{
      margin-top:10px;padding:10px;border:1px dashed #444;border-radius:10px;background:#1b1b1b;
    }
    .mini-teste .row{align-items:center}
    .mini-teste input{margin:0}
    .mini-teste button{min-width:160px}

    .btn-ajuste{
      background: #374151;
      color: #fff;
      padding: 4px 8px;
      font-size: 11px;
      border-radius: 4px;
      margin-left: 10px;
    }
    .btn-ajuste:hover{background: #4b5563;}

    footer{
      text-align:center;font-size:13px;color:#ccc;background:#2c2c2c;padding:10px 15px;border-radius:6px;margin:10px;max-width:980px;width:100%;
    }

    @media (max-width: 860px){
      .cards{grid-template-columns:1fr}
      .linha-botoes{flex-direction:column}
    }
  </style>
</head>
<body>

  <div class="top-nav">
    <a href="index.html" class="back-button">
      <i class="fas fa-arrow-left"></i> Voltar à Home
    </a>
  </div>

  <img src="logo.png" alt="Logo HS" class="logo-topo" />

  <div class="container">
    <div class="form-container">

      <!-- LOGIN -->
      <div id="login" class="login-box">
        <h2>Login da Filial</h2>
        <label for="codigo-filial">Código da Filial</label>
        <input id="codigo-filial" type="text" placeholder="Ex: 293, 488, 287, 288, 761" />
        <button class="btn-full" onclick="entrar()">
          <i class="fas fa-door-open"></i> Entrar
        </button>
      </div>

      <!-- PRINCIPAL -->
      <div id="principal" class="hidden">
        <div class="logout">
          <button class="btn-secundario" onclick="sair()">
            <i class="fas fa-sign-out-alt"></i> Sair
          </button>
        </div>

        <h1>Conferência de Nota Fiscal</h1>
        <div class="info-filial" id="info-filial"></div>

        <label for="chave">Chave de Acesso (44 dígitos)</label>
        <input id="chave" type="text" maxlength="44" placeholder="Digite ou leia o código de barras da NF" />

        <div class="linha-botoes">
          <button onclick="abrirLeitor('NF')">
            <i class="fas fa-camera"></i> Ler Chave da NF
          </button>
          <button onclick="carregarNF()">
            <i class="fas fa-cloud-download-alt"></i> Carregar Itens da NF
          </button>
        </div>

        <div id="loading" class="loading hidden">⏳ Carregando itens da NF...</div>
        <div id="erro" class="erro"></div>

        <!-- Painel -->
        <div id="painel" class="hidden">
          <div class="cards">
            <div class="card">
              <div class="titulo">Resumo da NF</div>
              <div id="resumo-nf" class="muted"></div>
              <div class="kpi"><strong>Total itens na NF</strong><span id="kpi-nf">0</span></div>
              <div class="kpi"><strong>Total escaneado</strong><span id="kpi-scan">0</span></div>
            </div>

            <div class="card">
              <div class="titulo">Scanner de Peças</div>
              <div class="muted">Escaneie os EANs das etiquetas. Vai somando automático.</div>

              <div class="linha-botoes" style="margin-top:10px">
                <button class="btn-ok" onclick="abrirLeitor('EAN')">
                  <i class="fas fa-barcode"></i> Escanear EAN (Peças)
                </button>
                <button class="btn-secundario" onclick="limparScans()">
                  <i class="fas fa-eraser"></i> Zerar Scans
                </button>
              </div>

              <!-- ✅ MODO TESTE (colar EAN) -->
              <div class="mini-teste">
                <div class="muted" style="margin-bottom:6px"><strong>Teste sem câmera:</strong> cole um EAN e clique em Adicionar</div>
                <div class="row" style="gap:10px">
                  <input id="ean-manual" type="text" placeholder="Cole aqui o EAN (somente números)" />
                  <button class="btn-ok" onclick="adicionarEANManual()">
                    <i class="fas fa-plus"></i> Adicionar
                  </button>
                </div>
              </div>

              <div class="linha-botoes">
                <button class="btn-full" onclick="fazerConferencia()">
                  <i class="fas fa-clipboard-check"></i> Fazer Conferência
                </button>
                <button id="btn-enviar" class="btn-full hidden" onclick="enviarConferencia()">
                  <i class="fas fa-paper-plane"></i> Enviar Resultado
                </button>
              </div>

              <div id="msg" class="loading hidden"></div>
            </div>
          </div>

          <div class="campo-pesquisa">
            <label for="filtro">Buscar (EAN / referência / cor / tamanho)</label>
            <input id="filtro" type="text" placeholder="Digite para filtrar..." />
          </div>

          <div class="titulo">
            Resultado da Conferência
            <small id="resumo-div"></small>
          </div>

          <div id="lista" class="lista"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scanner -->
  <div id="scanner">
    <button class="scanner-close" onclick="fecharLeitor()">
      <i class="fas fa-times"></i> Fechar
    </button>
    <div id="scanner-view"></div>
    <div class="scanner-info" id="scanner-info"></div>

    <!-- trava de toque -->
    <div id="tapNext" class="tap-to-next hidden" onclick="liberarProximoScan()">
      ✅ Lido! Toque aqui para escanear o próximo
      <small>(Evita bips duplos acidentais)</small>
    </div>
  </div>

  <script>
    // CONFIGURAÇÕES
    const URL_API = "SUA_URL_DO_WEB_APP_AQUI"; // Substitua pela sua URL
    const SENHA_AJUSTE = "1234";
    const filiaisValidas = ["293","488","287","288","761"];
    const nomesFiliais = {
      "293":"ARTUR",
      "488":"FLORIANO",
      "287":"JOTA",
      "288":"MODA",
      "761":"PONTO"
    };

    let filialAtual = "";
    let cabecalhoAtual = null;
    let itensNF = [];
    let mapaScan = {};
    let termoFiltro = "";
    let scannerInstance = null;
    let modoScanner = "";
    let scanTravado = false;
    let audioCtx = null;
    let travaBipManual = false; // Trava para o campo manual

    // -------- Login --------
    function entrar(){
      const f = document.getElementById("codigo-filial").value.trim();
      if(!filiaisValidas.includes(f)){
        alert("Código de filial inválido.");
        return;
      }
      filialAtual = f;
      localStorage.setItem("filial_conf_nf", f);
      document.getElementById("login").classList.add("hidden");
      document.getElementById("principal").classList.remove("hidden");
      document.getElementById("info-filial").textContent = `Filial logada: ${f} - ${nomesFiliais[f] || ""}`;
    }

    function sair(){
      if(!confirm("Deseja sair?")) return;
      localStorage.removeItem("filial_conf_nf");
      location.reload();
    }

    // -------- Busca NF --------
    async function carregarNF(){
      const chave = document.getElementById("chave").value.trim();
      const erro = document.getElementById("erro");
      const loading = document.getElementById("loading");
      const painel = document.getElementById("painel");

      erro.textContent = "";
      if(chave.length !== 44){
        erro.textContent = "A chave deve ter 44 dígitos.";
        return;
      }

      loading.classList.remove("hidden");
      painel.classList.add("hidden");
      cabecalhoAtual = null;
      itensNF = [];
      mapaScan = {};
      document.getElementById("btn-enviar").classList.add("hidden");

      try{
        const resp = await fetch(`${URL_API}?api=consultarConferenciaNF&filial=${filialAtual}&chave=${chave}`);
        const data = await resp.json();

        if(!data.success) throw new Error(data.message || "Erro desconhecido.");

        cabecalhoAtual = data.cabecalho;
        itensNF = data.itens || [];
        
        document.getElementById("resumo-nf").innerHTML = `
          <strong>NF:</strong> ${cabecalhoAtual.numeroNF} | 
          <strong>Emissão:</strong> ${cabecalhoAtual.dataEmissao}<br/>
          <strong>Emitente:</strong> ${cabecalhoAtual.nomeEmitente}
        `;
        
        atualizarKPIs();
        render(montarListaConferencia(false));
        painel.classList.remove("hidden");

      }catch(err){
        erro.textContent = "Erro: " + (err.message || err);
      }finally{
        loading.classList.add("hidden");
      }
    }

    function atualizarKPIs(){
      let totalNF = 0;
      itensNF.forEach(i => totalNF += (i.quantidade || 0));
      
      let totalScan = 0;
      for(let k in mapaScan) totalScan += mapaScan[k];

      document.getElementById("kpi-nf").textContent = totalNF;
      document.getElementById("kpi-scan").textContent = totalScan;
    }

    function limparScans(){
      if(!confirm("Zerar todas as contagens feitas até agora?")) return;
      mapaScan = {};
      atualizarKPIs();
      render(montarListaConferencia(false));
      document.getElementById("btn-enviar").classList.add("hidden");
    }

    // -------- Lógica de Conferência --------
    function fazerConferencia(){
      const lista = montarListaConferencia(true);
      render(lista);
      document.getElementById("btn-enviar").classList.remove("hidden");
      document.getElementById("lista").scrollIntoView({behavior:"smooth"});
    }

    function montarListaConferencia(aplicarStatus){
      const eansNF = itensNF.map(i => i.ean);
      const eansScan = Object.keys(mapaScan);
      const todosEANs = [...new Set([...eansNF, ...eansScan])];

      let arr = todosEANs.map(ean => {
        const itemNF = itensNF.find(i => i.ean === ean);
        const qtdNF = itemNF ? itemNF.quantidade : 0;
        const qtdScan = mapaScan[ean] || 0;
        const diff = qtdScan - qtdNF;

        let status = "OK";
        if(qtdScan === 0 && qtdNF > 0) status = "FALTANDO";
        else if(qtdScan > 0 && qtdNF === 0) status = "EXTRA";
        else if(qtdScan < qtdNF) status = "FALTANDO";
        else if(qtdScan > qtdNF) status = "PASSANDO";

        return {
          ean,
          codigo: itemNF ? itemNF.codigo : "?",
          cor: itemNF ? itemNF.cor : "?",
          tamanho: itemNF ? itemNF.tamanho : "?",
          qtdNF,
          qtdScan,
          diff,
          status
        };
      });

      if(termoFiltro){
        const t = termoFiltro.toLowerCase();
        arr = arr.filter(x =>
          (x.ean||"").toLowerCase().includes(t) ||
          (x.codigo||"").toLowerCase().includes(t) ||
          (x.cor||"").toLowerCase().includes(t) ||
          (x.tamanho||"").toLowerCase().includes(t)
        );
      }

      if(aplicarStatus){
        const peso = s => (s==="FALTANDO"?0:s==="PASSANDO"?1:s==="EXTRA"?2:3);
        arr.sort((a,b)=>peso(a.status)-peso(b.status));

        const falt = arr.filter(x=>x.status==="FALTANDO").length;
        const pass = arr.filter(x=>x.status==="PASSANDO").length;
        const extra = arr.filter(x=>x.status==="EXTRA").length;
        document.getElementById("resumo-div").textContent = `Faltando: ${falt} | Passando: ${pass} | Extras: ${extra}`;
      }

      return arr;
    }

    function render(lista){
      const div = document.getElementById("lista");
      div.innerHTML = "";

      if(!lista.length){
        div.innerHTML = `<div class="muted">Nenhum item para mostrar.</div>`;
        return;
      }

      lista.forEach((item, index)=>{
        const el = document.createElement("div");
        el.className = "item";

        const badgeClass =
          item.status==="OK" ? "badge ok" :
          item.status==="FALTANDO" ? "badge faltando" :
          item.status==="PASSANDO" ? "badge passando" :
          item.status==="EXTRA" ? "badge extra" : "badge";

        const badgeText =
          item.status==="OK" ? "OK" :
          item.status==="FALTANDO" ? "FALTANDO" :
          item.status==="PASSANDO" ? "PASSANDO" :
          item.status==="EXTRA" ? "EXTRA (NÃO CONSTA NA NF)" : item.status;

        el.innerHTML = `
          <div class="row">
            <div><strong>EAN:</strong> <span class="muted">${item.ean}</span></div>
            <div>
              <span class="${badgeClass}">${badgeText}</span>
              <button class="btn-ajuste" onclick="ajusteManual('${item.ean}')">
                <i class="fas fa-edit"></i> Ajustar
              </button>
            </div>
          </div>
          <div class="row">
            <div><strong>Ref/Cor:</strong> <span class="muted">${(item.codigo || "-")} / ${(item.cor || "-")}</span></div>
            <div><strong>Tam:</strong> <span class="muted">${(item.tamanho || "-")}</span></div>
            <div><strong>NF:</strong> <span class="muted">${item.qtdNF}</span></div>
            <div><strong>Scan:</strong> <span class="muted">${item.qtdScan}</span></div>
            <div><strong>Dif:</strong> <span class="muted">${item.diff}</span></div>
          </div>
        `;
        div.appendChild(el);
      });
    }

    // -------- Ajuste Manual com Senha --------
    function ajusteManual(ean){
      const senha = prompt("Digite a senha para ajuste manual:");
      if(senha !== SENHA_AJUSTE){
        alert("Senha incorreta!");
        return;
      }
      const atual = mapaScan[ean] || 0;
      const nova = prompt(`Ajustar quantidade para o EAN ${ean}:`, atual);
      if(nova !== null){
        mapaScan[ean] = parseInt(nova) || 0;
        if(mapaScan[ean] <= 0) delete mapaScan[ean];
        atualizarKPIs();
        const jaConferido = !document.getElementById("btn-enviar").classList.contains("hidden");
        render(montarListaConferencia(jaConferido));
      }
    }

    // -------- Beep --------
    function beepOk(){
      try{
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = "square";
        o.frequency.value = 880;
        g.gain.value = 0.08;
        o.connect(g);
        g.connect(audioCtx.destination);
        o.start();
        setTimeout(()=>{ o.stop(); }, 120);
      }catch(e){}
    }

    // -------- Scanner --------
    async function abrirLeitor(modo){
      const scannerDiv = document.getElementById("scanner");
      const scannerView = document.getElementById("scanner-view");
      const info = document.getElementById("scanner-info");
      const tapNext = document.getElementById("tapNext");

      modoScanner = modo;
      scanTravado = false;
      tapNext.classList.add("hidden");

      if(modoScanner === "EAN" && !cabecalhoAtual){
        alert("Carregue a NF primeiro.");
        return;
      }

      scannerView.innerHTML = "";
      scannerDiv.style.display = "flex";
      info.innerHTML = (modoScanner === "NF")
        ? "Aponte para o código de barras da NF (chave 44).<br/>Ao ler, fecha automaticamente."
        : "Aponte para o EAN das peças.<br/><strong>Lê 1 vez</strong>, dá bip, e <strong>trava</strong> até você tocar para ler o próximo.";

      try{
        if(scannerInstance){
          await scannerInstance.hide().catch(()=>{});
          await scannerInstance.stop().catch(()=>{});
          await scannerInstance.destroyContext().catch(()=>{});
          scannerInstance = null;
        }

        scannerInstance = await Dynamsoft.DBR.BarcodeScanner.createInstance();
        await scannerInstance.updateRuntimeSettings("speed");

        scannerInstance.onFrameRead = results => {
          if(!results || !results.length) return;
          if(modoScanner === "EAN" && scanTravado) return;

          for (let r of results){
            const code = (r.barcodeText || "").trim();
            if(!code) continue;

            if(modoScanner === "NF"){
              const only = code.replace(/\D/g,'');
              if(only.length >= 44){
                document.getElementById("chave").value = only.substring(0,44);
                beepOk();
                fecharLeitor();
                return;
              }
            } else {
              const ean = normalizarEAN(code);
              if(!ean) return;
              adicionarScan(ean);
              beepOk();
              travarAteToque();
              return;
            }
          }
        };

        await scannerInstance.show(scannerView);

      }catch(ex){
        alert("Erro ao iniciar o leitor: " + (ex.message || ex));
        scannerDiv.style.display = "none";
      }
    }

    function travarAteToque(){
      const tapNext = document.getElementById("tapNext");
      scanTravado = true;
      tapNext.classList.remove("hidden");
    }

    function liberarProximoScan(){
      const tapNext = document.getElementById("tapNext");
      scanTravado = false;
      tapNext.classList.add("hidden");
    }

    function normalizarEAN(code){
      const only = (code || "").replace(/\D/g,"");
      if(only.length < 8) return "";
      return only.length > 14 ? only.substring(0,14) : only;
    }

    function adicionarScan(ean){
      mapaScan[ean] = Number(mapaScan[ean] || 0) + 1;
      atualizarKPIs();
      const jaConferido = !document.getElementById("btn-enviar").classList.contains("hidden");
      render(montarListaConferencia(jaConferido));
    }

    function adicionarEANManual(){
      if(!cabecalhoAtual){
        alert("Carregue a NF primeiro.");
        return;
      }
      if(travaBipManual) return; // Evita duplo bip manual
      
      const inp = document.getElementById("ean-manual");
      const ean = normalizarEAN(inp.value || "");
      if(!ean){
        alert("EAN inválido.");
        return;
      }

      travaBipManual = true;
      adicionarScan(ean);
      beepOk();
      inp.value = "";
      inp.focus();

      setTimeout(() => { travaBipManual = false; }, 500); // Libera após 500ms
    }

    async function fecharLeitor(){
      const scannerDiv = document.getElementById("scanner");
      const tapNext = document.getElementById("tapNext");
      tapNext.classList.add("hidden");
      scanTravado = false;

      try{
        if(scannerInstance){
          await scannerInstance.hide();
          await scannerInstance.stop();
          await scannerInstance.destroyContext();
          scannerInstance = null;
        }
      }catch(e){}
      scannerDiv.style.display = "none";
    }

    // -------- Envio e Limpeza --------
    async function enviarConferencia(){
      const erro = document.getElementById("erro");
      const msg = document.getElementById("msg");
      erro.textContent = "";

      if(!cabecalhoAtual){
        erro.textContent = "Nenhuma NF carregada.";
        return;
      }

      if(!confirm("Deseja enviar o resultado da conferência para o banco?")) return;

      msg.textContent = "Enviando resultado da conferência...";
      msg.classList.remove("hidden");

      const listaFinal = montarListaConferencia(true);

      const payload = {
        api: "registrarConferenciaNF",
        filialCodigo: filialAtual,
        filialNome: nomesFiliais[filialAtual] || "",
        numeroNF: cabecalhoAtual.numeroNF || "",
        chaveAcesso: cabecalhoAtual.chaveAcesso || document.getElementById("chave").value.trim(),
        dataConferencia: new Date().toISOString(),
        totalNF: Number(document.getElementById("kpi-nf").textContent || 0),
        totalScan: Number(document.getElementById("kpi-scan").textContent || 0),
        itens: listaFinal.map(i => ({
          ean: i.ean,
          codigo: i.codigo,
          cor: i.cor,
          tamanho: i.tamanho,
          qtdNF: i.qtdNF,
          qtdScan: i.qtdScan,
          diff: i.diff,
          status: i.status
        }))
      };

      try{
        const resp = await fetch(URL_API, {
          method: "POST",
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        if(!data.success) throw new Error(data.message || "Falha ao registrar conferência.");
        
        alert("Conferência registrada com sucesso!");
        limparTela();
      }catch(err){
        erro.textContent = "Erro ao enviar: " + (err.message || err);
      }finally{
        msg.classList.add("hidden");
      }
    }

    function limparTela(){
      // Reseta variáveis
      cabecalhoAtual = null;
      mapaScan = {};
      itensNF = [];
      termoFiltro = "";
      
      // Reseta campos visuais
      document.getElementById("chave").value = "";
      document.getElementById("filtro").value = "";
      document.getElementById("ean-manual").value = "";
      document.getElementById("painel").classList.add("hidden");
      document.getElementById("btn-enviar").classList.add("hidden");
      document.getElementById("resumo-div").textContent = "";
      document.getElementById("lista").innerHTML = "";
      
      // Foco na chave para a próxima nota
      document.getElementById("chave").focus();
      console.log("Tela limpa para nova conferência.");
    }

    // filtro + boot
    window.addEventListener("load", ()=>{
      const f = localStorage.getItem("filial_conf_nf");
      if(f && filiaisValidas.includes(f)){
        filialAtual = f;
        document.getElementById("login").classList.add("hidden");
        document.getElementById("principal").classList.remove("hidden");
        document.getElementById("info-filial").textContent = `Filial logada: ${f} - ${nomesFiliais[f] || ""}`;
      }

      document.getElementById("filtro").addEventListener("input", (e)=>{
        termoFiltro = e.target.value.trim();
        const jaConferido = !document.getElementById("btn-enviar").classList.contains("hidden");
        render(montarListaConferencia(jaConferido));
      });

      document.getElementById("ean-manual").addEventListener("keydown", (e)=>{
        if(e.key === "Enter"){
          e.preventDefault();
          adicionarEANManual();
        }
      });
    });
  </script>
</body>
</html>
Problemas de duplicidade e ajustes no sistema GS - Manus
