<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- For√ßar atualiza√ß√£o do cache -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  
  <title>Confer√™ncia de Nota Fiscal - HS</title>

  <!-- Adicionar par√¢metro de vers√£o para for√ßar atualiza√ß√£o -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css?version=2.0" />
  <script src="https://cdn.jsdelivr.net/npm/dynamsoft-javascript-barcode@9.6.21/dist/dbr.js?version=2.0"></script>

  <style>
    *{box-sizing:border-box}
    body{
      font-family: Arial, sans-serif;
      background:#000;color:#fff;margin:0;padding:0;
      min-height:100vh;display:flex;flex-direction:column;align-items:center;
      /* MELHORIA: Brilho base aumentado */
      filter: brightness(1.05);
    }

    /* MELHORIA: Classe para brilho m√°ximo no scanner */
    .scanner-active { filter: brightness(1.5) !important; }

    .top-nav{width:100%;display:flex;justify-content:center;margin:24px 0 4px}
    .back-button{
      position:static!important;display:inline-flex;align-items:center;gap:8px;
      padding:8px 18px;border-radius:999px;border:1px solid #1f2937;background:#111827;
      color:#e5e7eb;font-size:.9rem;text-decoration:none;box-shadow:0 10px 40px rgba(15,23,42,.6);
    }
    .back-button:hover{background:#1f2937}

    .logo-topo{width:100px;height:auto;margin:10px 0 10px}

    .container{
      width:100%;max-width:980px;background:#2c2c2c;
      padding:30px 20px 25px;border-radius:12px;box-shadow:0 0 10px rgba(0,0,0,.5);
      margin:20px 10px;
    }
    .form-container{
      max-width:820px;margin:0 auto;background:#1e1e1e;padding:25px 20px;border-radius:8px;
      box-shadow:0 2px 10px rgba(0,0,0,.3);
    }
    h1,h2{margin:0 0 12px;text-align:center}
    label{font-size:14px;font-weight:600;display:block;margin:10px 0 6px;color:#ccc}
    input{
      width:100%;padding:10px 12px;font-size:14px;border:1px solid #444;border-radius:6px;
      background:#2a2a2a;color:#fff;margin-bottom:8px;
    }
    input:focus{outline:none;border-color:#43b0ff;box-shadow:0 0 0 2px rgba(67,176,255,.25)}

    button{
      background:#673ab7;color:#fff;border:none;padding:10px 18px;border-radius:8px;
      font-size:14px;cursor:pointer;font-weight:700;transition:.2s;display:inline-flex;gap:8px;align-items:center;justify-content:center
    }
    button:hover{background:#5e35b1}
    .btn-secundario{background:#5f6368}
    .btn-secundario:hover{background:#3c4043}
    .btn-ok{background:#0f766e}
    .btn-ok:hover{background:#115e59}
    .btn-full{width:100%;margin-top:8px}
    .linha-botoes{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 5px}
    .linha-botoes button{flex:1;min-width:160px}

    .hidden{display:none}

    .login-box{margin-bottom:15px;border-bottom:1px solid #333;padding-bottom:15px}
    .logout{text-align:right;margin-bottom:10px}
    .info-filial{font-size:13px;color:#bbb;margin-bottom:10px}
    .loading{font-style:italic;color:#1a73e8;font-size:13px;margin-top:10px;text-align:center}
    .erro{color:#f97373;font-size:13px;margin-top:8px}

    .cards{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    .card{background:#252525;border:1px solid #3b3b3b;border-radius:10px;padding:12px}
    .kpi{
      display:flex;justify-content:space-between;align-items:center;
      padding:8px 10px;border-radius:10px;background:#202020;border:1px solid #303030;
      margin-top:8px;font-size:14px;
    }
    .kpi strong{color:#e5e7eb}
    .kpi span{color:#cbd5e1;font-weight:700}

    .titulo{margin-top:18px;margin-bottom:8px;font-size:15px;font-weight:800;display:flex;justify-content:space-between;align-items:center}
    .titulo small{color:#cbd5e1;font-weight:600}

    .lista{
      margin-top:6px;display:flex;flex-direction:column;gap:8px;
      max-height:360px;overflow:auto;padding-right:4px;
    }
    .item{
      background:#262626;border:1px solid #3b3b3b;border-radius:10px;padding:10px;
      display:flex;flex-direction:column;gap:6px;font-size:13px;
    }
    .row{display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap}
    .muted{color:#cbd5e1}
    .badge{
      font-size:12px;padding:4px 10px;border-radius:999px;font-weight:800;
      background:#374151;color:#e5e7eb;display:inline-flex;align-items:center;gap:6px;
    }
    .ok{background:#064e3b;color:#bbf7d0}
    .faltando{background:#78350f;color:#fed7aa}
    .passando{background:#7f1d1d;color:#fecaca}
    .extra{background:#1f2937;color:#e5e7eb;border:1px solid #374151}

    .campo-pesquisa{margin-top:14px}

    /* Scanner */
    #scanner{
      width:100%;height:100vh;position:fixed;inset:0;z-index:1000;
      display:none;justify-content:center;align-items:center;flex-direction:column;
      background:rgba(0,0,0,.85);
    }
    #scanner video,#scanner canvas{max-width:92vw;max-height:72vh}
    .scanner-info{margin-top:10px;font-size:14px;text-align:center;color:#e5e7eb}
    .scanner-close{
      position:absolute;top:15px;right:15px;background:#111827;border-radius:999px;padding:8px 12px;font-size:12px
    }

    .tap-to-next{
      margin-top:10px;
      padding:10px 14px;
      border:1px solid #334155;
      background:#0b1220;
      border-radius:12px;
      color:#e5e7eb;
      font-weight:800;
      text-align:center;
      width:min(520px, 92vw);
      cursor:pointer;
      user-select:none;
    }
    .tap-to-next small{display:block;color:#94a3b8;font-weight:700;margin-top:4px}

    .mini-teste{
      margin-top:10px;padding:10px;border:1px dashed #444;border-radius:10px;background:#1b1b1b;
    }
    .mini-teste .row{align-items:center}
    .mini-teste input{margin:0}
    .mini-teste button{min-width:160px}

    .btn-ajuste{
      background: #374151;
      color: #fff;
      padding: 4px 8px;
      font-size: 11px;
      border-radius: 4px;
      margin-left: 10px;
      cursor: pointer;
    }
    .btn-ajuste:hover{background: #4b5563;}

    /* Modal de Diverg√™ncias */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.85);
      display: none; justify-content: center; align-items: center; z-index: 2000;
    }
    .modal-content {
      background: #1e1e1e; padding: 25px; border-radius: 12px; width: 90%; max-width: 600px;
      border: 1px solid #444; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    .modal-header { color: #f97373; font-size: 1.2rem; font-weight: 800; margin-bottom: 15px; text-align: center; }
    .modal-body { max-height: 300px; overflow-y: auto; margin-bottom: 20px; font-size: 14px; }
    .modal-item { padding: 10px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
    .modal-footer { text-align: center; }

    footer{
      text-align:center;font-size:13px;color:#ccc;background:#2c2c2c;padding:10px 15px;border-radius:6px;margin:10px;max-width:980px;width:100%;
    }

    @media (max-width: 860px){
      .cards{grid-template-columns:1fr}
      .linha-botoes{flex-direction:column}
    }
  </style>
</head>
<!-- MELHORIA: Clique em qualquer lugar para liberar scanner -->
<body onclick="liberarScannerGlobal()">

  <div class="top-nav">
    <a href="index.html?version=2.0" class="back-button">
      <i class="fas fa-arrow-left"></i> Voltar √† Home
    </a>
  </div>

  <img src="logo.png?version=2.0" alt="Logo HS" class="logo-topo" />

  <div class="container">
    <div class="form-container">

      <!-- LOGIN -->
      <div id="login" class="login-box">
        <h2>Login da Filial</h2>
        <label for="codigo-filial">C√≥digo da Filial</label>
        <input id="codigo-filial" type="text" placeholder="Ex: 293, 488, 287, 288, 761" />
        <button class="btn-full" onclick="entrar()">
          <i class="fas fa-door-open"></i> Entrar
        </button>
      </div>

      <!-- PRINCIPAL -->
      <div id="principal" class="hidden">
        <div class="logout">
          <button class="btn-secundario" onclick="sair()">
            <i class="fas fa-sign-out-alt"></i> Sair
          </button>
        </div>

        <h1>Confer√™ncia de Nota Fiscal</h1>
        <div class="info-filial" id="info-filial"></div>

        <label for="chave">Chave de Acesso (44 d√≠gitos)</label>
        <input id="chave" type="text" maxlength="44" placeholder="Digite ou leia o c√≥digo de barras da NF" />

        <div class="linha-botoes">
          <button onclick="abrirLeitor('NF')">
            <i class="fas fa-camera"></i> Ler Chave da NF
          </button>
          <button onclick="carregarNF()">
            <i class="fas fa-cloud-download-alt"></i> Carregar Itens da NF
          </button>
        </div>

        <div id="loading" class="loading hidden">‚è≥ Carregando itens da NF...</div>
        <div id="erro" class="erro"></div>

        <!-- Painel -->
        <div id="painel" class="hidden">
          <div class="cards">
            <div class="card">
              <div class="titulo">Resumo da NF</div>
              <div class="muted" id="resumo-nf"></div>
              <div class="kpi"><strong>Total itens na NF</strong><span id="kpi-nf">0</span></div>
              <div class="kpi"><strong>Total escaneado</strong><span id="kpi-scan">0</span></div>
            </div>

            <div class="card">
              <div class="titulo">Scanner de Pe√ßas</div>
              <div class="muted">Escaneie os EANs das etiquetas. Vai somando autom√°tico.</div>

              <div class="linha-botoes" style="margin-top:10px">
                <button class="btn-ok" onclick="abrirLeitor('EAN')">
                  <i class="fas fa-barcode"></i> Escanear EAN (Pe√ßas)
                </button>
                <button class="btn-secundario" onclick="limparScans()">
                  <i class="fas fa-eraser"></i> Zerar Scans
                </button>
              </div>

              <!-- ‚úÖ MODO TESTE (colar EAN) -->
              <div class="mini-teste">
                <div class="muted" style="margin-bottom:6px"><strong>Teste sem c√¢mera:</strong> cole um EAN e clique em Adicionar</div>
                <div id="buffer-ean" class="loading hidden" style="margin-bottom:5px">üîç Buscando dados no banco...</div>
                <div class="row" style="gap:10px">
                  <input id="ean-manual" type="text" placeholder="Cole aqui o EAN (somente n√∫meros)" />
                  <button class="btn-ok" onclick="adicionarEANManual()">
                    <i class="fas fa-plus"></i> Adicionar
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="titulo">
            Itens da Nota Fiscal
            <small id="contagem-itens">0 itens</small>
          </div>

          <div class="campo-pesquisa">
            <input type="text" id="pesquisa" placeholder="üîç Filtrar por EAN, Refer√™ncia ou Tamanho..." oninput="renderizarItens()" />
          </div>

          <div id="lista-itens" class="lista"></div>

          <button class="btn-ok btn-full" style="margin-top:20px" onclick="finalizarConferencia()">
            <i class="fas fa-check-circle"></i> Fazer Confer√™ncia
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scanner Overlay -->
  <div id="scanner">
    <div class="scanner-close" onclick="fecharLeitor()">
      <i class="fas fa-times"></i> Fechar
    </div>
    <div id="video-container" style="position:relative"></div>
    <div class="scanner-info" id="scanner-info">Aproxime o c√≥digo de barras</div>
    
    <!-- MELHORIA: Mensagem de toque para liberar -->
    <div class="tap-to-next" id="tap-to-next" onclick="proximoScan()">
      <i class="fas fa-hand-pointer"></i> TOQUE AQUI PARA LIBERAR PR√ìXIMO SCAN
      <small>(Ou toque em qualquer lugar da tela)</small>
    </div>
  </div>

  <!-- Modal de Diverg√™ncias -->
  <div id="modalDivergencias" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">‚ö†Ô∏è DIVERG√äNCIAS IDENTIFICADAS</div>
      <div id="modalCorpo" class="modal-body"></div>
      <div class="modal-footer">
        <p class="muted" style="margin-bottom:15px">Favor fazer uma confer√™ncia dos mesmos.</p>
        <button class="btn-primary" onclick="fecharModal()">Entendido</button>
      </div>
    </div>
  </div>

  <footer>
    &copy; 2025 HS - Sistema de Confer√™ncia de Notas Fiscais. Todos os direitos reservados.
  </footer>

  <script>
    let scanner = null;
    let modoLeitura = 'NF'; // 'NF' ou 'EAN'
    let itensNF = [];
    let bipes = {};
    let dicionarioExtra = {}; // Para guardar ref/cor/tam de itens extras
    let filialLogada = null;
    let nfCabecalho = null;
    let canScan = true;

    // MELHORIA: Fun√ß√£o para liberar scanner em qualquer lugar
    function liberarScannerGlobal() {
      if (document.getElementById('scanner').style.display === 'flex') {
        proximoScan();
      }
    }

    async function entrar() {
      const cod = document.getElementById('codigo-filial').value.trim();
      if(!cod) return alert("Digite o c√≥digo da filial!");
      filialLogada = cod;
      document.getElementById('login').classList.add('hidden');
      document.getElementById('principal').classList.remove('hidden');
      document.getElementById('info-filial').innerText = "Filial: " + cod;
      
      // Recuperar bipes salvos (Anti-Inatividade)
      const salvos = localStorage.getItem('bipes_' + cod);
      if(salvos) bipes = JSON.parse(salvos);
    }

    function sair() {
      if(!confirm("Deseja sair?")) return;
      localStorage.removeItem('bipes_' + filialLogada);
      location.reload();
    }

    async function abrirLeitor(modo) {
      modoLeitura = modo;
      document.getElementById('scanner').style.display = 'flex';
      document.getElementById('scanner-info').innerText = modo === 'NF' ? "Leia a Chave da NF" : "Leia o EAN da Pe√ßa";
      
      // MELHORIA: Brilho m√°ximo ao abrir scanner
      document.body.classList.add('scanner-active');

      if (!scanner) {
        scanner = await Dynamsoft.DBR.BarcodeScanner.createInstance();
        await scanner.setUIElement(document.getElementById('video-container'));
        scanner.onFrameRead = results => {};
        scanner.onUniqueRead = (txt, result) => {
          if (!canScan) return;
          
          // MELHORIA: Filtro de EAN (Ignora c√≥digos laterais com mais de 14 d√≠gitos)
          let eanLimpo = txt.replace(/\D/g, '');
          if (modoLeitura === 'EAN' && (eanLimpo.length < 12 || eanLimpo.length > 14)) {
            console.log("C√≥digo lateral ignorado:", eanLimpo);
            return;
          }

          canScan = false;
          processarLeitura(txt);
          if (navigator.vibrate) navigator.vibrate(100);
        };
      }
      await scanner.show();
    }

    function fecharLeitor() {
      if (scanner) scanner.hide();
      document.getElementById('scanner').style.display = 'none';
      // MELHORIA: Remove brilho ao fechar
      document.body.classList.remove('scanner-active');
    }

    function proximoScan() {
      canScan = true;
      document.getElementById('scanner-info').innerText = "Aproxime o pr√≥ximo c√≥digo...";
      document.getElementById('scanner-info').style.color = "#fff";
    }

    function processarLeitura(txt) {
      if (modoLeitura === 'NF') {
        document.getElementById('chave').value = txt;
        fecharLeitor();
        carregarNF();
      } else {
        const ean = txt.replace(/\D/g, '');
        bipes[ean] = (bipes[ean] || 0) + 1;
        
        // Salva no localStorage (Anti-Inatividade)
        localStorage.setItem('bipes_' + filialLogada, JSON.stringify(bipes));

        // Sincroniza com o servidor (Colaborativo)
        google.script.run.registrarBipeIndividual({
          chaveAcesso: nfCabecalho.chaveAcesso,
          ean: ean,
          conferente: "Estoquista"
        });

        document.getElementById('scanner-info').innerText = "LIDO: " + ean;
        document.getElementById('scanner-info').style.color = "#4ade80";
        
        atualizarKPIs();
        renderizarItens();
      }
    }

    function carregarNF() {
      const chave = document.getElementById('chave').value.trim();
      if (chave.length !== 44) return alert("Chave deve ter 44 d√≠gitos!");

      document.getElementById('loading').classList.remove('hidden');
      document.getElementById('erro').innerText = "";
      document.getElementById('painel').classList.add('hidden');

      google.script.run.withSuccessHandler(res => {
        document.getElementById('loading').classList.add('hidden');
        if (res.success) {
          nfCabecalho = res.cabecalho;
          itensNF = res.itens;
          dicionarioExtra = res.itensExtra || {};
          
          // Sincroniza bipes j√° feitos por outros (Colaborativo)
          itensNF.forEach(it => {
            const eanLimpo = it.ean.replace(/\D/g, '');
            if (it.jaEscaneado > 0) {
              bipes[eanLimpo] = Math.max(bipes[eanLimpo] || 0, it.jaEscaneado);
            }
          });

          document.getElementById('painel').classList.remove('hidden');
          document.getElementById('resumo-nf').innerText = `NF: ${res.cabecalho.numeroNF} | ${res.cabecalho.nomeEmitente}`;
          atualizarKPIs();
          renderizarItens();
        } else {
          document.getElementById('erro').innerText = res.message;
        }
      }).consultarConferenciaNF(filialLogada, chave);
    }

    function atualizarKPIs() {
      const totalNF = itensNF.reduce((acc, cur) => acc + cur.quantidade, 0);
      let totalScan = 0;
      for (let ean in bipes) totalScan += bipes[ean];

      document.getElementById('kpi-nf').innerText = totalNF;
      document.getElementById('kpi-scan').innerText = totalScan;
    }

    function renderizarItens() {
      const lista = document.getElementById('lista-itens');
      const busca = document.getElementById('pesquisa').value.toLowerCase();
      lista.innerHTML = "";

      // 1. Itens que est√£o na NF
      itensNF.forEach(it => {
        const eanLimpo = it.ean.replace(/\D/g, '');
        const scan = bipes[eanLimpo] || 0;
        const diff = scan - it.quantidade;
        
        if (busca && !it.ean.includes(busca) && !it.codigo.toLowerCase().includes(busca)) return;

        const div = document.createElement('div');
        div.className = "item";
        
        let statusClass = "ok";
        let statusText = "CONFERIDO";
        if (diff < 0) { statusClass = "faltando"; statusText = "FALTANDO"; }
        if (diff > 0) { statusClass = "passando"; statusText = "PASSANDO"; }

        div.innerHTML = `
          <div class="row">
            <strong>EAN: ${it.ean}</strong>
            <span class="badge ${statusClass}">${statusText}</span>
          </div>
          <div class="muted">Ref/Cor: ${it.codigo} / ${it.cor}  Tam: ${it.tamanho}</div>
          <div class="row">
            <span>NF: ${it.quantidade} | Scan: ${scan}</span>
            <span style="font-weight:bold; color:${diff === 0 ? '#4ade80' : '#f87171'}">Dif: ${diff}</span>
          </div>
        `;
        lista.appendChild(div);
      });

      // 2. Itens Extras (Bipados mas n√£o est√£o na NF)
      for (let ean in bipes) {
        const eanLimpo = ean.replace(/\D/g, '');
        const naNF = itensNF.some(it => it.ean.replace(/\D/g, '') === eanLimpo);
        if (!naNF) {
          const info = dicionarioExtra[ean] || dicionarioExtra[eanLimpo] || { codigo: '---', cor: '---', tamanho: '---' };
          const div = document.createElement('div');
          div.className = "item";
          div.innerHTML = `
            <div class="row">
              <strong>EAN: ${ean}</strong>
              <span class="badge extra">EXTRA</span>
            </div>
            <div class="muted">Ref/Cor: ${info.codigo} / ${info.cor}  Tam: ${info.tamanho}</div>
            <div class="row">
              <span>NF: 0 | Scan: ${bipes[ean]}</span>
              <span style="font-weight:bold; color:#60a5fa">Dif: ${bipes[ean]}</span>
            </div>
          `;
          lista.appendChild(div);
        }
      }
      
      document.getElementById('contagem-itens').innerText = lista.children.length + " itens exibidos";
    }

    function adicionarEANManual() {
      const input = document.getElementById('ean-manual');
      const ean = input.value.trim().replace(/\D/g, '');
      if (!ean) return;
      
      // MELHORIA: Filtro de EAN no manual tamb√©m
      if (ean.length < 12 || ean.length > 14) return alert("C√≥digo lateral ou inv√°lido!");

      document.getElementById('buffer-ean').classList.remove('hidden');
      
      // Busca info no banco se for extra
      google.script.run.withSuccessHandler(res => {
        document.getElementById('buffer-ean').classList.add('hidden');
        if (res.success && res.itens[ean]) {
          dicionarioExtra[ean] = res.itens[ean];
        }
        bipes[ean] = (bipes[ean] || 0) + 1;
        localStorage.setItem('bipes_' + filialLogada, JSON.stringify(bipes));
        input.value = "";
        atualizarKPIs();
        renderizarItens();
      }).buscarInfoEAN({ eans: [ean] });
    }

    function limparScans() {
      if (!confirm("Deseja zerar todos os bipes desta nota?")) return;
      bipes = {};
      localStorage.removeItem('bipes_' + filialLogada);
      atualizarKPIs();
      renderizarItens();
    }

    function finalizarConferencia() {
      const divergencias = [];
      
      // Verifica itens da NF
      itensNF.forEach(it => {
        const scan = bipes[it.ean.replace(/\D/g, '')] || 0;
        if (scan !== it.quantidade) {
          divergencias.push({ desc: `${it.codigo} / ${it.cor} / ${it.tamanho}`, diff: scan - it.quantidade });
        }
      });

      // Verifica extras
      for (let ean in bipes) {
        const naNF = itensNF.some(it => it.ean.replace(/\D/g, '') === ean.replace(/\D/g, ''));
        if (!naNF) {
          const info = dicionarioExtra[ean] || { codigo: '---', cor: '---', tamanho: '---' };
          divergencias.push({ desc: `${info.codigo} / ${info.cor} / ${info.tamanho} (EXTRA)`, diff: bipes[ean] });
        }
      }

      if (divergencias.length > 0) {
        mostrarModal(divergencias);
      } else {
        enviarResultado();
      }
    }

    function mostrarModal(divs) {
      const corpo = document.getElementById('modalCorpo');
      corpo.innerHTML = divs.map(d => `
        <div class="modal-item">
          <span>${d.desc}</span>
          <strong style="color:${d.diff > 0 ? '#60a5fa' : '#f87171'}">Dif: ${d.diff}</strong>
        </div>
      `).join('');
      document.getElementById('modalDivergencias').style.display = 'flex';
    }

    function fecharModal() {
      document.getElementById('modalDivergencias').style.display = 'none';
      if (confirm("Deseja enviar o relat√≥rio mesmo com diverg√™ncias?")) {
        enviarResultado();
      }
    }

    function enviarResultado() {
      const payload = {
        api: 'registrarConferenciaNF',
        filialCodigo: filialLogada,
        numeroNF: nfCabecalho.numeroNF,
        chaveAcesso: nfCabecalho.chaveAcesso,
        totalNF: document.getElementById('kpi-nf').innerText,
        totalScan: document.getElementById('kpi-scan').innerText,
        conferente: "Estoquista",
        itens: []
      };

      // Monta lista final
      itensNF.forEach(it => {
        const scan = bipes[it.ean.replace(/\D/g, '')] || 0;
        payload.itens.push({
          ean: it.ean, codigo: it.codigo, cor: it.cor, tamanho: it.tamanho,
          qtdNF: it.quantidade, qtdScan: scan, diff: scan - it.quantidade,
          status: scan === it.quantidade ? 'OK' : (scan < it.quantidade ? 'FALTANDO' : 'PASSANDO')
        });
      });

      for (let ean in bipes) {
        const naNF = itensNF.some(it => it.ean.replace(/\D/g, '') === ean.replace(/\D/g, ''));
        if (!naNF) {
          const info = dicionarioExtra[ean] || { codigo: '---', cor: '---', tamanho: '---' };
          payload.itens.push({
            ean: ean, codigo: info.codigo, cor: info.cor, tamanho: info.tamanho,
            qtdNF: 0, qtdScan: bipes[ean], diff: bipes[ean], status: 'EXTRA'
          });
        }
      }

      google.script.run.withSuccessHandler(res => {
        if (res.success) {
          alert("Confer√™ncia enviada com sucesso!");
          localStorage.removeItem('bipes_' + filialLogada);
          location.reload();
        } else {
          alert("Erro ao enviar: " + res.message);
        }
      }).registrarConferenciaNF(payload);
    }
  </script>
</body>
</html>
