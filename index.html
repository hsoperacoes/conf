<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <title>Conferência de Nota Fiscal - HS</title>

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css?version=2.2" />

  <!-- ✅ Html5Qrcode (usado para NF 44 e EAN) -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    *{box-sizing:border-box}
    body{
      font-family: Arial, sans-serif;
      background:#000;color:#fff;margin:0;padding:0;
      min-height:100vh;display:flex;flex-direction:column;align-items:center;
    }

    .top-nav{width:100%;display:flex;justify-content:center;margin:24px 0 4px}
    .back-button{
      position:static!important;display:inline-flex;align-items:center;gap:8px;
      padding:8px 18px;border-radius:999px;border:1px solid #1f2937;background:#111827;
      color:#e5e7eb;font-size:.9rem;text-decoration:none;box-shadow:0 10px 40px rgba(15,23,42,.6);
    }
    .back-button:hover{background:#1f2937}
    .logo-topo{width:100px;height:auto;margin:10px 0 10px}

    .container{
      width:100%;max-width:980px;background:#2c2c2c;
      padding:30px 20px 25px;border-radius:12px;box-shadow:0 0 10px rgba(0,0,0,.5);
      margin:20px 10px;
    }
    .form-container{
      max-width:820px;margin:0 auto;background:#1e1e1e;padding:25px 20px;border-radius:8px;
      box-shadow:0 2px 10px rgba(0,0,0,.3);
    }
    h1,h2{margin:0 0 12px;text-align:center}
    label{font-size:14px;font-weight:600;display:block;margin:10px 0 6px;color:#ccc}
    input{
      width:100%;padding:10px 12px;font-size:14px;border:1px solid #444;border-radius:6px;
      background:#2a2a2a;color:#fff;margin-bottom:8px;
    }
    input:focus{outline:none;border-color:#43b0ff;box-shadow:0 0 0 2px rgba(67,176,255,.25)}

    button{
      background:#673ab7;color:#fff;border:none;padding:10px 18px;border-radius:8px;
      font-size:14px;cursor:pointer;font-weight:700;transition:.2s;display:inline-flex;gap:8px;align-items:center;justify-content:center
    }
    button:hover{background:#5e35b1}
    .btn-secundario{background:#5f6368}
    .btn-secundario:hover{background:#3c4043}
    .btn-ok{background:#0f766e}
    .btn-ok:hover{background:#115e59}
    .btn-full{width:100%;margin-top:8px}
    .linha-botoes{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 5px}
    .linha-botoes button{flex:1;min-width:160px}

    .hidden{display:none}

    .login-box{margin-bottom:15px;border-bottom:1px solid #333;padding-bottom:15px}
    .logout{text-align:right;margin-bottom:10px}
    .info-filial{font-size:13px;color:#bbb;margin-bottom:6px}
    .info-conferente{font-size:13px;color:#bbb;margin-bottom:10px}
    .loading{font-style:italic;color:#1a73e8;font-size:13px;margin-top:10px;text-align:center}
    .erro{color:#f97373;font-size:13px;margin-top:8px}

    .cards{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    .card{background:#252525;border:1px solid #3b3b3b;border-radius:10px;padding:12px}
    .kpi{
      display:flex;justify-content:space-between;align-items:center;
      padding:8px 10px;border-radius:10px;background:#202020;border:1px solid #303030;
      margin-top:8px;font-size:14px;
    }
    .kpi strong{color:#e5e7eb}
    .kpi span{color:#cbd5e1;font-weight:700}

    .titulo{margin-top:18px;margin-bottom:8px;font-size:15px;font-weight:800;display:flex;justify-content:space-between;align-items:center}
    .titulo small{color:#cbd5e1;font-weight:600}

    .lista{
      margin-top:6px;display:flex;flex-direction:column;gap:8px;
      max-height:360px;overflow:auto;padding-right:4px;
    }
    .item{
      background:#262626;border:1px solid #3b3b3b;border-radius:10px;padding:10px;
      display:flex;flex-direction:column;gap:6px;font-size:13px;
    }
    .row{display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap}
    .muted{color:#cbd5e1}
    .badge{
      font-size:12px;padding:4px 10px;border-radius:999px;font-weight:800;
      background:#374151;color:#e5e7eb;display:inline-flex;align-items:center;gap:6px;
    }
    .ok{background:#064e3b;color:#bbf7d0}
    .faltando{background:#78350f;color:#fed7aa}
    .passando{background:#7f1d1d;color:#fecaca}
    .extra{background:#1f2937;color:#e5e7eb;border:1px solid #374151}

    .campo-pesquisa{margin-top:14px}

    /* =========================================================
       ✅ SCANNER OVERLAY
    ========================================================= */
    #scanner{
      width:100vw;height:100vh;position:fixed;inset:0;z-index:1000;
      display:none;justify-content:center;align-items:center;flex-direction:column;
      background:rgba(0,0,0,.75);
      backdrop-filter: blur(6px);
    }
    #scanner *{pointer-events:auto}

    .scanner-close{
      position:absolute;top:15px;right:15px;
      background:rgba(17,24,39,.92);
      color:#fff;border:1px solid #374151;padding:10px 20px;border-radius:999px;
      font-weight:700;cursor:pointer;z-index:1001;
      display:flex;align-items:center;gap:8px;
    }

    .scanner-info{
      margin-top:20px;color:#fff;text-align:center;font-size:16px;
      background:rgba(17,24,39,.85);padding:15px 25px;border-radius:16px;
      border:1px solid #374151;max-width:85%;line-height:1.4;
      box-shadow:0 10px 30px rgba(0,0,0,.4);
    }
    .scanner-info-highlight{color:#a78bfa;font-weight:800}

    /* Estilo quando pausado */
    .scanner-paused{
      border: 4px solid #10b981 !important;
      box-shadow: 0 0 40px rgba(16,185,129,0.4) !important;
    }
    .scanner-info-paused{
      background: rgba(6,78,59,0.9) !important;
      border-color: #10b981 !important;
    }

    .scanner-notification{
      position:fixed;top:20px;left:50%;transform:translateX(-50%);
      background:#10b981;color:#fff;padding:12px 24px;border-radius:12px;
      font-weight:800;display:flex;align-items:center;gap:12px;z-index:2000;
      box-shadow:0 10px 25px rgba(0,0,0,.3);
      animation: slideDown 0.4s ease-out;
    }
    @keyframes slideDown{
      from{top:-100px;opacity:0}
      to{top:20px;opacity:1}
    }
    .scanner-notification i{font-size:20px}
    .scanner-notification .ean{font-family:monospace;background:rgba(0,0,0,.2);padding:2px 6px;border-radius:4px}

    /* =========================================================
       ✅ MODAL DIVERGÊNCIA
    ========================================================= */
    .modal-overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.8);
      display:none;justify-content:center;align-items:center;z-index:2000;
      padding:20px;
    }
    .modal-content{
      background:#1e1e1e;width:100%;max-width:500px;border-radius:16px;
      border:1px solid #333;padding:25px;box-shadow:0 20px 50px rgba(0,0,0,.5);
    }
    .modal-header{font-size:18px;font-weight:900;color:#f97373;margin-bottom:15px;text-align:center}
    .modal-body{max-height:300px;overflow:auto;margin-bottom:20px}
    .modal-item{
      background:#262626;padding:10px;border-radius:8px;margin-bottom:8px;
      border-left:4px solid #f97373;font-size:13px;
    }
    .modal-footer{text-align:center}
    .modal-footer button{width:100%;padding:12px;background:#444}

    footer{margin:30px 0;font-size:12px;color:#666;text-align:center}

    @media(max-width:600px){
      .cards{grid-template-columns:1fr}
      .linha-botoes button{flex:1 1 100%}
    }
  </style>
</head>
<body>

  <div class="top-nav">
    <a href="https://hs-sistema.github.io/Menu/" class="back-button">
      <i class="fas fa-arrow-left"></i> Voltar ao Menu
    </a>
  </div>

  <img src="https://i.ibb.co/p6pYvPz/HS-LOGOTIPO-BRANCO.png" class="logo-topo" alt="HS Logo" />

  <div class="container">
    <!-- TELA DE LOGIN -->
    <div id="login" class="form-container">
      <h1>Conferência NF</h1>
      <div class="login-box">
        <label>Código da Filial</label>
        <input type="number" id="codigo-filial" placeholder="Ex: 293" />
        <label>Nome do Conferente</label>
        <input type="text" id="nome-conferente" placeholder="Seu nome" />
        <button class="btn-full" onclick="entrar()">
          <i class="fas fa-sign-in-alt"></i> Acessar Sistema
        </button>
      </div>
    </div>

    <!-- TELA PRINCIPAL -->
    <div id="principal" class="hidden">
      <div class="logout">
        <button class="btn-secundario" onclick="sair()">
          <i class="fas fa-sign-out-alt"></i> Sair
        </button>
      </div>

      <div id="info-filial" class="info-filial"></div>
      <div id="info-conferente" class="info-conferente"></div>

      <div class="form-container">
        <label>Chave de Acesso (44 dígitos)</label>
        <div style="display:flex;gap:8px">
          <input type="text" id="chave" maxlength="44" placeholder="Cole ou escaneie a chave" />
          <button onclick="abrirLeitor('NF')" title="Escanear Chave">
            <i class="fas fa-barcode"></i>
          </button>
        </div>
        <button class="btn-full btn-ok" onclick="carregarNF()">
          <i class="fas fa-search"></i> Carregar Nota Fiscal
        </button>
        <div id="loading" class="loading hidden">Buscando dados da NF...</div>
        <div id="erro" class="erro"></div>
        <div id="msg" class="loading hidden" style="color:#10b981"></div>
      </div>

      <div id="painel" class="hidden">
        <div class="cards">
          <div class="card">
            <div class="kpi"><strong>Total NF:</strong> <span id="kpi-nf">0</span></div>
            <div class="kpi"><strong>Total Scan:</strong> <span id="kpi-scan">0</span></div>
          </div>
          <div class="card">
            <div class="kpi"><strong>Itens OK:</strong> <span id="kpi-ok" style="color:#10b981">0</span></div>
            <div class="kpi"><strong>Divergentes:</strong> <span id="kpi-erro" style="color:#f97373">0</span></div>
          </div>
        </div>

        <div class="linha-botoes">
          <button onclick="abrirLeitor('EAN')">
            <i class="fas fa-camera"></i> ESCANEAR PEÇAS
          </button>
          <button class="btn-secundario" onclick="zerarConferencia()">
            <i class="fas fa-trash"></i> ZERAR TUDO
          </button>
        </div>

        <div class="form-container campo-pesquisa">
          <label>Adicionar EAN Manualmente</label>
          <div style="display:flex;gap:8px">
            <input type="text" id="ean-manual" placeholder="Digite o EAN e aperte Enter" />
            <button onclick="adicionarEANManual()">
              <i class="fas fa-plus"></i>
            </button>
          </div>
        </div>

        <div class="form-container campo-pesquisa">
          <label>Filtrar na Lista</label>
          <input type="text" id="filtro" placeholder="Filtrar por EAN, Ref ou Cor..." />
        </div>

        <button id="btn-enviar" class="btn-full btn-ok hidden" style="margin-top:20px; padding:15px; font-size:16px" onclick="enviarConferencia()">
          <i class="fas fa-cloud-upload-alt"></i> FINALIZAR E ENVIAR CONFERÊNCIA
        </button>

        <div id="resumo-div" style="margin-top:15px; font-weight:bold; text-align:center"></div>

        <div class="titulo">
          LISTA DE ITENS <small id="buffer-ean" class="hidden" style="color:#f59e0b">⏳ Buscando info...</small>
        </div>

        <div id="lista" class="lista"></div>
      </div>
    </div>
  </div>

  <div id="scanner">
    <button class="scanner-close" onclick="fecharLeitor(); event.stopPropagation();">
      <i class="fas fa-times"></i> Fechar
    </button>

    <div id="scanner-view"></div>
    <div id="scanner-info" class="scanner-info"></div>
  </div>

  <div id="modal-divergencia" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">⚠️ DIVERGÊNCIAS IDENTIFICADAS</div>
      <div class="modal-body" id="modal-lista"></div>
      <div class="modal-footer">
        <p style="font-size: 13px; color: #bbb; margin-bottom: 15px;">Favor fazer uma conferência dos mesmos.</p>
        <button onclick="fecharModal()">Entendido</button>
      </div>
    </div>
  </div>

  <footer>
    &copy; 2025 HS - Sistema de Conferência de Notas Fiscais. Versão 2.3
  </footer>

  <script>
    const APP_VERSION = "2.3";

    const URL_API = "https://script.google.com/macros/s/AKfycbx1HDzA2b478DAhi5ONS6TstKieKf4lvFM9wzib9McUrdP7Z4Xwhb6SrUt5KW1YcR3x/exec";

    const filiaisValidas = ["293", "488", "287", "288", "761"];
    const nomesFiliais = { "293":"ARTUR","488":"FLORIANO","287":"JOTA","288":"PONTO","761":"MODA" };

    let filialAtual = "";
    let conferenteAtual = "";

    let cabecalhoAtual = null;
    let itensNF = [];
    let mapaScan = {};
    let termoFiltro = "";

    // Scanner
    let html5ScannerEAN = null;
    let html5ScannerNF = null;
    let modoScanner = "";
    let audioCtx = null;

    let cacheInfoEAN = {};

    // ✅ CONTROLE REFORÇADO SCANNER EAN - AGORA COM FLAG DE BLOQUEIO
    let scannerBloqueado = false; // ✅ NOVA VARIÁVEL: bloqueia totalmente novos scans
    let ultimoEanLido = "";
    let ultimoEanTimestamp = 0;
    let processandoBipe = false; // ✅ NOVA FLAG: impede processamento simultâneo

    // Sync
    let syncTimer = null;
    let syncAtivo = false;
    let ultimoSyncHash = "";

    async function postJSON_(payload){
      const resp = await fetch(URL_API, {
        method: "POST",
        headers: { "Content-Type":"text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      });
      return await resp.json();
    }

    function entrar(){
      const f = document.getElementById("codigo-filial").value.trim();
      const nome = document.getElementById("nome-conferente").value.trim();

      if(!filiaisValidas.includes(f)){ alert("Código de filial inválido."); return; }
      if(!nome){ alert("Informe o nome do conferente."); return; }

      filialAtual = f;
      conferenteAtual = nome;

      localStorage.setItem("filial_conf_nf", f);
      localStorage.setItem("conferente_conf_nf", nome);

      document.getElementById("login").classList.add("hidden");
      document.getElementById("principal").classList.remove("hidden");

      atualizarInfoTopo_();
    }

    function atualizarInfoTopo_(){
      document.getElementById("info-filial").textContent = `Filial logada: ${filialAtual} - ${nomesFiliais[filialAtual] || ""}`;
      document.getElementById("info-conferente").textContent = `Conferente: ${conferenteAtual || "—"}`;
    }

    function sair(){
      if(!confirm("Deseja realmente sair?")) return;
      localStorage.removeItem("filial_conf_nf");
      localStorage.removeItem("conferente_conf_nf");
      location.reload();
    }

    async function carregarNF(){
      const chave = document.getElementById("chave").value.trim();
      const erro = document.getElementById("erro");
      const loading = document.getElementById("loading");

      erro.textContent = "";
      if(chave.length !== 44){ erro.textContent = "A chave deve ter 44 dígitos."; return; }

      loading.classList.remove("hidden");
      document.getElementById("painel").classList.add("hidden");

      try{
        const url = `${URL_API}?api=consultarConferenciaNF&filial=${filialAtual}&chave=${chave}&t=${Date.now()}`;
        const resp = await fetch(url);
        const data = await resp.json();

        if(!data.success){
          erro.textContent = data.message || "Erro ao buscar NF.";
          return;
        }

        cabecalhoAtual = data.cabecalho;
        itensNF = data.itens || [];
        
        // Inicia o mapaScan com o que já foi escaneado (sync do banco)
        mapaScan = {};
        itensNF.forEach(it => {
          if(it.jaEscaneado > 0) mapaScan[it.ean] = it.jaEscaneado;
        });

        document.getElementById("painel").classList.remove("hidden");
        render(montarListaConferencia(false));
        
        iniciarSync_();

      }catch(err){
        erro.textContent = "Erro de conexão: " + err.message;
      }finally{
        loading.classList.add("hidden");
      }
    }

    function iniciarSync_(){
      pararSync_();
      syncAtivo = true;
      puxarSyncAgora_();
      syncTimer = setInterval(puxarSyncAgora_, 5000);
    }

    function pararSync_(){
      syncAtivo = false;
      if(syncTimer) clearInterval(syncTimer);
      syncTimer = null;
    }

    async function puxarSyncAgora_(){
      if(!syncAtivo || !cabecalhoAtual) return;
      try{
        const url = `${URL_API}?api=sincronizarBipes&chave=${cabecalhoAtual.chaveAcesso}&t=${Date.now()}`;
        const resp = await fetch(url);
        const data = await resp.json();

        if(data.success && data.bipes){
          const novoHash = JSON.stringify(data.bipes);
          if(novoHash !== ultimoSyncHash){
            ultimoSyncHash = novoHash;
            mapaScan = data.bipes;
            const jaConferido = !document.getElementById("btn-enviar").classList.contains("hidden");
            render(montarListaConferencia(jaConferido));
          }
        }
      }catch(e){}
    }

    function montarListaConferencia(jaConferido){
      const lista = [];
      const eansNaNota = new Set();

      itensNF.forEach(it => {
        const ean = it.ean;
        eansNaNota.add(ean);
        const qtdScan = Number(mapaScan[ean] || 0);
        const diff = qtdScan - it.quantidade;

        let status = "PENDENTE";
        if(qtdScan === it.quantidade) status = "OK";
        else if(qtdScan < it.quantidade) status = "FALTANDO";
        else status = "PASSANDO";

        lista.push({
          ean,
          codigo: it.codigo,
          cor: it.cor,
          tamanho: it.tamanho,
          qtdNF: it.quantidade,
          qtdScan,
          diff,
          status,
          naNota: true
        });
      });

      Object.keys(mapaScan).forEach(ean => {
        if(!eansNaNota.has(ean)){
          const info = cacheInfoEAN[ean] || { codigo:"?", cor:"?", tamanho:"?" };
          const qtdScan = Number(mapaScan[ean] || 0);
          lista.push({
            ean,
            codigo: info.codigo,
            cor: info.cor,
            tamanho: info.tamanho,
            qtdNF: 0,
            qtdScan,
            diff: qtdScan,
            status: "EXTRA",
            naNota: false
          });
        }
      });

      let filtrada = lista;
      if(termoFiltro){
        const t = termoFiltro.toLowerCase();
        filtrada = lista.filter(i => 
          i.ean.includes(t) || 
          String(i.codigo).toLowerCase().includes(t) || 
          String(i.cor).toLowerCase().includes(t)
        );
      }

      // Ordenação: Erros primeiro, depois OK
      filtrada.sort((a,b) => {
        if(a.status === "OK" && b.status !== "OK") return 1;
        if(a.status !== "OK" && b.status === "OK") return -1;
        return 0;
      });

      return filtrada;
    }

    function render(lista){
      const container = document.getElementById("lista");
      container.innerHTML = "";

      let totalNF = 0;
      let totalScan = 0;
      let totalOK = 0;
      let totalErro = 0;

      lista.forEach(it => {
        if(it.naNota) totalNF += it.qtdNF;
        totalScan += it.qtdScan;

        if(it.status === "OK") totalOK++;
        else totalErro++;

        const div = document.createElement("div");
        div.className = "item";
        
        let badgeClass = "badge";
        if(it.status === "OK") badgeClass += " ok";
        else if(it.status === "FALTANDO") badgeClass += " faltando";
        else if(it.status === "PASSANDO") badgeClass += " passando";
        else if(it.status === "EXTRA") badgeClass += " extra";

        div.innerHTML = `
          <div class="row">
            <span style="font-weight:800; font-size:14px">${it.codigo} - ${it.cor} (${it.tamanho})</span>
            <span class="${badgeClass}">${it.status}</span>
          </div>
          <div class="row muted">
            <span>EAN: ${it.ean}</span>
            <span>NF: <strong>${it.qtdNF}</strong> | Scan: <strong style="color:#fff">${it.qtdScan}</strong></span>
          </div>
          <div class="row" style="margin-top:4px">
            <span style="font-size:11px; color:${it.diff===0?'#10b981':'#f97373'}">
              ${it.diff === 0 ? "Qtd correta" : (it.diff > 0 ? `+${it.diff} peça(s) a mais` : `${it.diff} peça(s) faltando`)}
            </span>
            <button class="btn-secundario" style="padding:4px 10px; font-size:11px" onclick="ajustarManual('${it.ean}', ${it.qtdScan})">
              <i class="fas fa-edit"></i> Ajustar
            </button>
          </div>
        `;
        container.appendChild(div);
      });

      document.getElementById("kpi-nf").textContent = totalNF;
      document.getElementById("kpi-scan").textContent = totalScan;
      document.getElementById("kpi-ok").textContent = totalOK;
      document.getElementById("kpi-erro").textContent = totalErro;

      const btnEnviar = document.getElementById("btn-enviar");
      const resumoDiv = document.getElementById("resumo-div");

      if(totalScan > 0 && totalScan >= totalNF){
        btnEnviar.classList.remove("hidden");
        if(totalScan === totalNF && totalErro === 0){
          resumoDiv.innerHTML = `<span style="color:#10b981"><i class="fas fa-check-double"></i> TUDO CONFERIDO E OK!</span>`;
        } else {
          resumoDiv.innerHTML = `<span style="color:#f59e0b"><i class="fas fa-exclamation-triangle"></i> CONFERÊNCIA COM DIVERGÊNCIAS</span>`;
        }
      } else {
        btnEnviar.classList.add("hidden");
        resumoDiv.textContent = "";
      }
    }

    async function ajustarManual(ean, qtdAtual){
      const nova = prompt(`Ajustar quantidade para o EAN ${ean}:`, qtdAtual);
      if(nova === null) return;
      const n = parseInt(nova, 10);
      if(isNaN(n) || n < 0){ alert("Quantidade inválida."); return; }

      try{
        const res = await postJSON_({
          api: "ajustarBipeManual",
          chaveAcesso: cabecalhoAtual.chaveAcesso,
          ean: ean,
          novaQtd: n,
          conferente: conferenteAtual
        });
        if(res.success) puxarSyncAgora_();
        else alert("Erro: " + res.message);
      }catch(e){ alert("Erro de conexão."); }
    }

    async function zerarConferencia(){
      if(!confirm("Isso apagará TODOS os bipes desta nota. Tem certeza?")) return;
      try{
        const res = await postJSON_({
          api: "zerarSyncNF",
          chaveAcesso: cabecalhoAtual.chaveAcesso
        });
        if(res.success) puxarSyncAgora_();
      }catch(e){}
    }

    // =========================================================
    // ✅ LÓGICA DO SCANNER (Html5Qrcode)
    // =========================================================

    function beepOk() {
      try{
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.type = "sine";
        osc.frequency.setValueAtTime(880, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.1);
      }catch(e){}
    }

    function extrairChave44(t){
      const m = t.match(/\d{44}/);
      return m ? m[0] : null;
    }

    function extrairEAN13DoTexto(t){
      const m = t.match(/\d{13}/);
      return m ? m[0] : null;
    }

    function isValidEAN13(ean) {
      if (!/^\d{13}$/.test(ean)) return false;
      let sum = 0;
      for (let i = 0; i < 12; i++) {
        sum += parseInt(ean[i]) * (i % 2 === 0 ? 1 : 3);
      }
      const checkDigit = (10 - (sum % 10)) % 10;
      return checkDigit === parseInt(ean[12]);
    }

    async function abrirLeitor(modo){
      if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      
      modoScanner = modo;
      const scannerDiv = document.getElementById("scanner");
      const scannerView = document.getElementById("scanner-view");
      const info = document.getElementById("scanner-info");

      scannerDiv.style.display = "flex";
      scannerView.innerHTML = "";
      
      // Reset flags
      scannerBloqueado = false;
      processandoBipe = false; // ✅ Reset flag
      ultimoEanLido = "";
      ultimoEanTimestamp = 0;

      if(modo === "NF"){
        info.innerHTML = `Aponte para o <span class="scanner-info-highlight">Código de Barras</span> da NF.`;
        await iniciarHtml5NF_(scannerView);
      } else {
        info.innerHTML = `Aponte para o <span class="scanner-info-highlight">EAN-13</span> das peças.<br/>Após ler, pausa automaticamente.`;
        await iniciarHtml5EAN_Bonito_(scannerView, info);
      }
    }

    async function pararScannerAtual_(){
      try{
        if(html5ScannerNF){
          await html5ScannerNF.stop();
          html5ScannerNF = null;
        }
        if(html5ScannerEAN){
          await html5ScannerEAN.stop();
          html5ScannerEAN = null;
        }
      }catch(e){}
    }

    async function iniciarHtml5NF_(scannerView){
      scannerView.innerHTML = `
        <div style="
          width:min(820px, 96vw);
          background:#0b0b0c;
          border:2px solid #673ab7;
          border-radius:16px;
          padding:14px;
          box-shadow:0 18px 70px rgba(103,58,183,.25);
        ">
          <div id="html5-nf44" style="width:100%; border-radius:12px; overflow:hidden;"></div>
          <div style="
            margin-top:10px; font-size:13px; color:#cbd5e1;
            background:rgba(31,41,55,.55);
            border:1px solid #374151;
            padding:10px 12px;border-radius:12px;
          ">
            Aponte para o <b>código de barras</b> da NF. Ao ler, preenche a chave e fecha automaticamente.
          </div>
        </div>
      `;

      html5ScannerNF = new Html5Qrcode("html5-nf44");

      const config = {
        fps: 14,
        qrbox: { width: 320, height: 220 },
        experimentalFeatures: { useBarCodeDetectorIfSupported: true },
        rememberLastUsedCamera: true
      };

      let travadoNF = false;

      await html5ScannerNF.start(
        { facingMode: "environment" },
        config,
        async (decodedText) => {
          if(modoScanner !== "NF") return;
          if(travadoNF) return;

          const chave = extrairChave44(decodedText);
          if(!chave) return;

          travadoNF = true;
          document.getElementById("chave").value = chave;
          beepOk();

          await new Promise(r => setTimeout(r, 120));
          await fecharLeitor();
        },
        ()=>{}
      );
    }

    function _mostrarNotificacaoEAN_(ean13){
      const scannerDiv = document.getElementById("scanner");

      const old = scannerDiv.querySelector(".scanner-notification");
      if(old) old.remove();

      const el = document.createElement("div");
      el.className = "scanner-notification";
      el.innerHTML = `
        <i class="fas fa-check-circle"></i>
        <div style="display:flex;flex-direction:column;gap:4px;align-items:center">
          <div class="title">CÓDIGO CAPTURADO!</div>
          <div class="sub">Toque na tela para escanear o próximo</div>
          <div class="ean">${ean13}</div>
        </div>
      `;
      scannerDiv.appendChild(el);

      setTimeout(()=>{ if(el.parentNode) el.remove(); }, 2600);
    }

    async function iniciarHtml5EAN_Bonito_(scannerView, info){
      scannerView.innerHTML = `<div id="html5-ean" style="width:min(720px, 92vw); border-radius:12px; overflow:hidden;"></div>`;
      html5ScannerEAN = new Html5Qrcode("html5-ean");

      const config = {
        fps: 8, // ✅ BAIXO FPS PARA MENOS FALSOS POSITIVOS
        qrbox: { width: 280, height: 280 },
        experimentalFeatures: { 
          useBarCodeDetectorIfSupported: true 
        },
        rememberLastUsedCamera: true
      };

      await html5ScannerEAN.start(
        { facingMode: "environment" },
        config,
        async (decodedText) => {
          if(modoScanner !== "EAN") return;
          
          // ✅ BLOQUEIO TOTAL - NÃO PROCESSAR NADA SE JÁ ESTIVER BLOQUEADO OU PROCESSANDO
          if(scannerBloqueado || processandoBipe) {
            return; // Sai imediatamente, não processa nada
          }
          
          // ✅ Filtro de qualidade
          const textoLimpo = String(decodedText || "").trim();
          if(textoLimpo.length < 10) {
            return; // Texto muito curto, ignora
          }
          
          const ean13 = extrairEAN13DoTexto(textoLimpo);
          if(!ean13) {
            return; // Não é EAN válido
          }

          // ✅ VERIFICAÇÃO DUPLA
          if(ean13.length !== 13 || !isValidEAN13(ean13)) {
            return;
          }

          // ✅ ANTI-BIPE DUPLO POR TIMESTAMP - 3 SEGUNDOS AGORA
          const agora = Date.now();
          if(ean13 === ultimoEanLido && (agora - ultimoEanTimestamp) < 3000) {
            return; // Mesmo EAN em menos de 3 segundos, ignora
          }

          // ✅ BLOQUEIA IMEDIATAMENTE ANTES DE QUALQUER PROCESSAMENTO
          processandoBipe = true;
          scannerBloqueado = true;
          
          // ✅ Atualiza controle de tempo
          ultimoEanLido = ean13;
          ultimoEanTimestamp = agora;

          // ✅ NÃO PAUSA O SCANNER! A câmera continua funcionando
          // Mas a flag scannerBloqueado já impede novos processamentos

          try{
            // ✅ Registra no servidor
            await registrarBipeServidor_(ean13);

            // ✅ Beep de confirmação
            beepOk();
            
            // ✅ Notificação visual
            _mostrarNotificacaoEAN_(ean13);

            // ✅ Atualiza UI para mostrar bloqueado
            scannerView.classList.add("scanner-paused");
            info.classList.add("scanner-info-paused");
            info.innerHTML = `
              ✅ <strong>EAN ${ean13}</strong> registrado!<br/>
              Toque em <span class="scanner-info-highlight">QUALQUER LUGAR</span> da tela para continuar.
            `;

            // ✅ NÃO TEM TIMEOUT! Fica bloqueado até o toque

          }catch(e){
            console.error("Erro ao registrar bipe:", e);
            // Se falhar, libera o bloqueio
            scannerBloqueado = false;
            scannerView.classList.remove("scanner-paused");
            info.classList.remove("scanner-info-paused");
          } finally {
            processandoBipe = false; // ✅ Libera flag de processamento
          }
        },
        (errorMsg) => {
          // Callback de erro - ignorar
        }
      );
    }

    async function registrarBipeServidor_(ean){
      if(!cabecalhoAtual || !cabecalhoAtual.chaveAcesso) return;

      const payload = {
        api: "registrarBipeIndividual",
        chaveAcesso: String(cabecalhoAtual.chaveAcesso || "").trim(),
        ean: String(ean || "").trim(),
        qtd: 1,
        conferente: conferenteAtual || "Usuário"
      };

      try{
        const data = await postJSON_(payload);
        if(data && data.success){
          const naNota = itensNF.some(i => String(i.ean||"") === String(ean));
          if(!naNota && !cacheInfoEAN[ean]) buscarEANNoBanco(ean);
          puxarSyncAgora_();
        }
      }catch(e){}
    }

    async function buscarEANNoBanco(ean){
      const buffer = document.getElementById("buffer-ean");
      buffer.classList.remove("hidden");
      try{
        const data = await postJSON_({
          api:"buscarInfoEAN",
          filial: filialAtual,
          eans:[ean]
        });
        if(data.success && data.itens && data.itens[ean]){
          cacheInfoEAN[ean] = data.itens[ean];
          const jaConferido = !document.getElementById("btn-enviar").classList.contains("hidden");
          render(montarListaConferencia(jaConferido));
        }
      }catch(e){
      }finally{
        buffer.classList.add("hidden");
      }
    }

    // ✅ Evento de toque para LIBERAR scanner
    document.addEventListener("click", async (e)=>{
      const scannerDiv = document.getElementById("scanner");
      if(scannerDiv.style.display !== "flex") return;
      if(modoScanner !== "EAN") return;
      
      // Não processa se clicar no botão de fechar
      if(e.target.closest(".scanner-close")) return;
      
      e.stopPropagation();
      e.preventDefault();
      
      // ✅ LIBERA O BLOQUEIO
      scannerBloqueado = false;
      processandoBipe = false;
      
      const scannerView = document.getElementById("scanner-view");
      const info = document.getElementById("scanner-info");
      
      scannerView.classList.remove("scanner-paused");
      info.classList.remove("scanner-info-paused");
      info.innerHTML = `
        ✅ <span class="scanner-info-highlight">Scanner liberado!</span><br/>
        Aponte para o próximo EAN-13.
      `;
      
      // ✅ Pequeno delay antes de voltar ao texto normal
      setTimeout(() => {
        if(modoScanner === "EAN" && scannerDiv.style.display === "flex") {
          info.innerHTML = `Aponte para o <span class="scanner-info-highlight">EAN-13</span> das peças.<br/>Após ler, pausa automaticamente.`;
        }
      }, 1500);
      
    }, true); // Use capture phase

    async function adicionarEANManual(){
      if(!cabecalhoAtual){ alert("Carregue a NF primeiro."); return; }
      if(processandoBipe) return; // ✅ Trava manual

      const inp = document.getElementById("ean-manual");
      const ean13 = extrairEAN13DoTexto(inp.value || "");
      if(!ean13){
        inp.value = ""; inp.focus(); return;
      }

      processandoBipe = true;
      try {
        await registrarBipeServidor_(ean13);
        beepOk();
        inp.value = ""; inp.focus();
      } finally {
        processandoBipe = false;
      }
    }

    async function fecharLeitor(){
      scannerBloqueado = false;
      processandoBipe = false;
      ultimoEanLido = "";
      ultimoEanTimestamp = 0;
      
      await pararScannerAtual_();
      const scannerDiv = document.getElementById("scanner");
      scannerDiv.style.display = "none";

      const notif = scannerDiv.querySelector(".scanner-notification");
      if(notif) notif.remove();

      modoScanner = "";
    }

    async function enviarConferencia(){
      const erro = document.getElementById("erro");
      const msg = document.getElementById("msg");
      erro.textContent = "";

      if(!cabecalhoAtual){ erro.textContent = "Nenhuma NF carregada."; return; }
      if(!confirm("Deseja enviar o resultado da conferência para o banco?")) return;

      msg.textContent = "Enviando resultado da conferência...";
      msg.classList.remove("hidden");

      const listaFinal = montarListaConferencia(true);

      const payload = {
        api: "registrarConferenciaNF",
        filialCodigo: filialAtual,
        filialNome: nomesFiliais[filialAtual] || "",
        numeroNF: cabecalhoAtual.numeroNF || "",
        chaveAcesso: cabecalhoAtual.chaveAcesso || document.getElementById("chave").value.trim(),
        dataConferencia: new Date().toISOString(),
        totalNF: Number(document.getElementById("kpi-nf").textContent || 0),
        totalScan: Number(document.getElementById("kpi-scan").textContent || 0),
        versaoApp: APP_VERSION,
        conferente: conferenteAtual || "Usuário",
        itens: listaFinal.map(i => ({
          ean: i.ean,
          codigo: i.codigo,
          cor: i.cor,
          tamanho: i.tamanho,
          qtdNF: i.qtdNF,
          qtdScan: i.qtdScan,
          diff: i.diff,
          status: i.status
        }))
      };

      try{
        const data = await postJSON_(payload);
        if(!data.success) throw new Error(data.message || "Falha ao registrar conferência.");
        alert("Conferência registrada com sucesso!");
        limparTela();
      }catch(err){
        erro.textContent = "Erro ao enviar: " + (err.message || err);
      }finally{
        msg.classList.add("hidden");
      }
    }

    function limparTela(){
      pararSync_();

      cabecalhoAtual = null;
      mapaScan = {};
      itensNF = [];
      termoFiltro = "";
      cacheInfoEAN = {};

      document.getElementById("chave").value = "";
      document.getElementById("filtro").value = "";
      document.getElementById("ean-manual").value = "";

      document.getElementById("painel").classList.add("hidden");
      document.getElementById("btn-enviar").classList.add("hidden");
      document.getElementById("resumo-div").textContent = "";
      document.getElementById("lista").innerHTML = "";

      document.getElementById("chave").focus();
    }

    window.addEventListener("load", ()=>{
      const f = localStorage.getItem("filial_conf_nf");
      const nome = localStorage.getItem("conferente_conf_nf");

      if(f && filiaisValidas.includes(f) && nome){
        filialAtual = f;
        conferenteAtual = nome;

        document.getElementById("login").classList.add("hidden");
        document.getElementById("principal").classList.remove("hidden");
        atualizarInfoTopo_();
      }

      document.getElementById("filtro").addEventListener("input", (e)=>{
        termoFiltro = e.target.value.trim();
        const jaConferido = !document.getElementById("btn-enviar").classList.contains("hidden");
        render(montarListaConferencia(jaConferido));
      });

      document.getElementById("ean-manual").addEventListener("keydown", (e)=>{
        if(e.key === "Enter"){
          e.preventDefault();
          adicionarEANManual();
        }
      });
    });
  </script>
</body>
</html>
