<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Conferência de Nota Fiscal - HS</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/dynamsoft-javascript-barcode@9.6.21/dist/dbr.js"></script>

  <style>
    /* ... (Estilos originais mantidos) ... */
    *{box-sizing:border-box}
    body{font-family:Arial,sans-serif;background:#000;color:#fff;margin:0;padding:0;min-height:100vh;display:flex;flex-direction:column;align-items:center}
    .container{width:100%;max-width:980px;background:#2c2c2c;padding:30px 20px 25px;border-radius:12px;box-shadow:0 0 10px rgba(0,0,0,.5);margin:20px 10px}
    .form-container{max-width:820px;margin:0 auto;background:#1e1e1e;padding:25px 20px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.3)}
    input{width:100%;padding:10px 12px;font-size:14px;border:1px solid #444;border-radius:6px;background:#2a2a2a;color:#fff;margin-bottom:8px}
    button{background:#673ab7;color:#fff;border:none;padding:10px 18px;border-radius:8px;font-size:14px;cursor:pointer;font-weight:700;transition:.2s;display:inline-flex;gap:8px;align-items:center;justify-content:center}
    .hidden{display:none}
    .card{background:#252525;border:1px solid #3b3b3b;border-radius:10px;padding:12px}
    .lista{margin-top:6px;display:flex;flex-direction:column;gap:8px;max-height:360px;overflow:auto;padding-right:4px}
    .item{background:#262626;border:1px solid #3b3b3b;border-radius:10px;padding:10px;display:flex;flex-direction:column;gap:6px;font-size:13px}
    .row{display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap}
    .badge{font-size:12px;padding:4px 10px;border-radius:999px;font-weight:800;background:#374151;color:#e5e7eb;display:inline-flex;align-items:center;gap:6px}
    .btn-ajuste{background:#374151;color:#fff;padding:4px 8px;font-size:11px;border-radius:4px;margin-left:10px}
    .tap-to-next{margin-top:10px;padding:10px 14px;border:1px solid #334155;background:#0b1220;border-radius:12px;color:#e5e7eb;font-weight:800;text-align:center;cursor:pointer}
  </style>
</head>
<body>

  <div class="container">
    <div class="form-container">
      <!-- LOGIN -->
      <div id="login">
        <h2>Login da Filial</h2>
        <input id="codigo-filial" type="text" placeholder="Ex: 293, 488, 287, 288, 761" />
        <button style="width:100%" onclick="entrar()">Entrar</button>
      </div>

      <!-- PRINCIPAL -->
      <div id="principal" class="hidden">
        <h1>Conferência de Nota Fiscal</h1>
        <input id="chave" type="text" maxlength="44" placeholder="Chave de Acesso" />
        <button onclick="carregarNF()">Carregar Itens</button>
        
        <div id="painel" class="hidden">
          <div class="card">
            <div id="kpi-nf">0</div>
            <div id="kpi-scan">0</div>
            <input id="ean-manual" type="text" placeholder="Bipe aqui" />
            <button onclick="adicionarEANManual()">Adicionar</button>
          </div>
          <div id="lista" class="lista"></div>
          <button id="btn-enviar" onclick="enviarConferencia()">Enviar Resultado</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const URL_API = "https://script.google.com/macros/s/AKfycbx1HDzA2b478DAhi5ONS6TstKieKf4lvFM9wzib9McUrdP7Z4Xwhb6SrUt5KW1YcR3x/exec";
    let filialAtual = "";
    let cabecalhoAtual = null;
    let itensNF = [];
    let mapaScan = {};
    let travaBipManual = false;

    function entrar(){
      filialAtual = document.getElementById("codigo-filial").value.trim();
      document.getElementById("login").classList.add("hidden");
      document.getElementById("principal").classList.remove("hidden");
    }

    async function carregarNF(){
      const chave = document.getElementById("chave").value.trim();
      const resp = await fetch(`${URL_API}?api=consultarConferenciaNF&filial=${filialAtual}&chave=${chave}`);
      const data = await resp.json();
      if(data.success){
        cabecalhoAtual = data.cabecalho;
        itensNF = data.itens;
        document.getElementById("painel").classList.remove("hidden");
        render();
      } else { alert(data.message); }
    }

    // TRAVA DE BIP DUPLO (500ms)
    function adicionarEANManual(){
      if(travaBipManual) return;
      const inp = document.getElementById("ean-manual");
      const ean = inp.value.trim();
      if(!ean) return;

      travaBipManual = true;
      mapaScan[ean] = (mapaScan[ean] || 0) + 1;
      render();
      inp.value = "";
      inp.focus();

      setTimeout(() => { travaBipManual = false; }, 500);
    }

    // AJUSTE MANUAL COM SENHA NO SERVIDOR
    async function ajusteManual(ean){
      const senha = prompt("Digite a senha para ajuste:");
      if(!senha) return;
      const resp = await fetch(`${URL_API}?api=validarSenha&senha=${senha}`);
      const data = await resp.json();
      if(data.success){
        const nova = prompt("Nova quantidade:", mapaScan[ean] || 0);
        if(nova !== null) {
          mapaScan[ean] = parseInt(nova) || 0;
          render();
        }
      } else { alert("Senha incorreta!"); }
    }

    function render(){
      const div = document.getElementById("lista");
      div.innerHTML = "";
      
      // Lógica de montagem da lista (Simplificada para o exemplo, use a sua completa)
      itensNF.forEach(it => {
        const qtdScan = mapaScan[it.ean] || 0;
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="row">
            <span>${it.codigo} - ${it.ean}</span>
            <button class="btn-ajuste" onclick="ajusteManual('${it.ean}')">Ajustar</button>
          </div>
          <div class="row">
            <span>NF: ${it.quantidade} | Scan: ${qtdScan}</span>
          </div>
        `;
        div.appendChild(el);
      });
      
      document.getElementById("kpi-nf").textContent = "Total NF: " + itensNF.reduce((a,b)=>a+b.quantidade,0);
      document.getElementById("kpi-scan").textContent = "Total Scan: " + Object.values(mapaScan).reduce((a,b)=>a+b,0);
    }

    async function enviarConferencia(){
      if(!confirm("Enviar resultado?")) return;
      const payload = {
        api: "registrarConferenciaNF",
        filialCodigo: filialAtual,
        numeroNF: cabecalhoAtual.numeroNF,
        chaveAcesso: cabecalhoAtual.chaveAcesso,
        totalNF: document.getElementById("kpi-nf").textContent,
        totalScan: document.getElementById("kpi-scan").textContent,
        itens: itensNF.map(it => ({
          ean: it.ean, codigo: it.codigo, cor: it.cor, tamanho: it.tamanho,
          qtdNF: it.quantidade, qtdScan: mapaScan[it.ean] || 0,
          diff: (mapaScan[it.ean] || 0) - it.quantidade,
          status: (mapaScan[it.ean] || 0) === it.quantidade ? "OK" : "DIVERGENTE"
        }))
      };

      const resp = await fetch(URL_API, { method: "POST", body: JSON.stringify(payload) });
      const res = await resp.json();
      if(res.success){
        alert("Enviado!");
        limparTela();
      }
    }

    function limparTela(){
      cabecalhoAtual = null;
      mapaScan = {};
      itensNF = [];
      document.getElementById("chave").value = "";
      document.getElementById("painel").classList.add("hidden");
      document.getElementById("lista").innerHTML = "";
    }
  </script>
</body>
</html>
