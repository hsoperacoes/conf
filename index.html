<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <title>Confer√™ncia de Nota Fiscal - HS</title>

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <script src="https://cdn.jsdelivr.net/npm/dynamsoft-javascript-barcode@9.6.21/dist/dbr.js"></script>
  <script>
    Dynamsoft.DBR.BarcodeScanner.license = "DLS2eyJvcmdhbml6YXRpb25JRCI6IjIwMDAwMSJ9";
    console.log("Licen√ßa Dynamsoft configurada");
  </script>
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    *{box-sizing:border-box}
    body{
      font-family: Arial, sans-serif;
      background:#000;color:#fff;margin:0;padding:0;
      min-height:100vh;display:flex;flex-direction:column;align-items:center;
    }

    .top-nav{width:100%;display:flex;justify-content:center;margin:24px 0 4px}
    .back-button{
      position:static!important;display:inline-flex;align-items:center;gap:8px;
      padding:8px 18px;border-radius:999px;border:1px solid #1f2937;background:#111827;
      color:#e5e7eb;font-size:.9rem;text-decoration:none;box-shadow:0 10px 40px rgba(15,23,42,.6);
    }
    .back-button:hover{background:#1f2937}

    .logo-topo{width:100px;height:auto;margin:10px 0 10px}

    .container{
      width:100%;max-width:980px;background:#2c2c2c;
      padding:30px 20px 25px;border-radius:12px;box-shadow:0 0 10px rgba(0,0,0,.5);
      margin:20px 10px;
    }
    .form-container{
      max-width:820px;margin:0 auto;background:#1e1e1e;padding:25px 20px;border-radius:8px;
      box-shadow:0 2px 10px rgba(0,0,0,.3);
    }
    h1,h2{margin:0 0 12px;text-align:center}
    label{font-size:14px;font-weight:600;display:block;margin:10px 0 6px;color:#ccc}
    input{
      width:100%;padding:10px 12px;font-size:14px;border:1px solid #444;border-radius:6px;
      background:#2a2a2a;color:#fff;margin-bottom:8px;
    }
    input:focus{outline:none;border-color:#43b0ff;box-shadow:0 0 0 2px rgba(67,176,255,.25)}

    button{
      background:#673ab7;color:#fff;border:none;padding:10px 18px;border-radius:8px;
      font-size:14px;cursor:pointer;font-weight:700;transition:.2s;display:inline-flex;gap:8px;align-items:center;justify-content:center
    }
    button:hover{background:#5e35b1}
    .btn-secundario{background:#5f6368}
    .btn-secundario:hover{background:#3c4043}
    .btn-ok{background:#0f766e}
    .btn-ok:hover{background:#115e59}
    .btn-warn{background:#9a3412}
    .btn-warn:hover{background:#7c2d12}
    .btn-full{width:100%;margin-top:8px}
    .linha-botoes{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 5px}
    .linha-botoes button{flex:1;min-width:160px}

    .hidden{display:none}

    .login-box{margin-bottom:15px;border-bottom:1px solid #333;padding-bottom:15px}
    .logout{text-align:right;margin-bottom:10px}
    .info-filial{font-size:13px;color:#bbb;margin-bottom:6px}
    .info-conferente{font-size:13px;color:#bbb;margin-bottom:10px}
    .loading{font-style:italic;color:#1a73e8;font-size:13px;margin-top:10px;text-align:center}
    .erro{color:#f97373;font-size:13px;margin-top:8px}

    .cards{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    .card{background:#252525;border:1px solid #3b3b3b;border-radius:10px;padding:12px}
    .kpi{
      display:flex;justify-content:space-between;align-items:center;
      padding:8px 10px;border-radius:10px;background:#202020;border:1px solid #303030;
      margin-top:8px;font-size:14px;
    }
    .kpi strong{color:#e5e7eb}
    .kpi span{color:#cbd5e1;font-weight:700}

    .titulo{margin-top:18px;margin-bottom:8px;font-size:15px;font-weight:800;display:flex;justify-content:space-between;align-items:center}
    .titulo small{color:#cbd5e1;font-weight:600}

    .lista{
      margin-top:6px;display:flex;flex-direction:column;gap:8px;
      max-height:360px;overflow:auto;padding-right:4px;
    }
    .item{
      background:#262626;border:1px solid #3b3b3b;border-radius:10px;padding:10px;
      display:flex;flex-direction:column;gap:6px;font-size:13px;
    }
    .row{display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap}
    .muted{color:#cbd5e1}
    .badge{
      font-size:12px;padding:4px 10px;border-radius:999px;font-weight:800;
      background:#374151;color:#e5e7eb;display:inline-flex;align-items:center;gap:6px;
    }
    .ok{background:#064e3b;color:#bbf7d0}
    .faltando{background:#78350f;color:#fed7aa}
    .passando{background:#7f1d1d;color:#fecaca}
    .extra{background:#1f2937;color:#e5e7eb;border:1px solid #374151}

    .campo-pesquisa{margin-top:14px}

    /* ===== Scanner container ===== */
    #scanner{
      width:100vw;height:100vh;position:fixed;inset:0;
      z-index:1000000;display:none;justify-content:center;align-items:center;flex-direction:column;
      background:rgba(0,0,0,.95);backdrop-filter:blur(8px);
    }
    #scanner.ean-mode{
      background:rgba(0,0,0,.95);backdrop-filter:blur(8px);
    }
    /* ‚úÖ NF: sem overlay escuro, mas SEM pointer-events none (isso atrapalha a c√¢mera/modal) */
    #scanner.nf-mode{
      background:transparent !important;
      backdrop-filter:none !important;
      pointer-events:auto !important;
    }

    #scanner-view{
      width:min(720px,92vw);background:#000;border:2px solid #673ab7;border-radius:16px;padding:15px;
      display:flex;align-items:center;justify-content:center;min-height:340px;cursor:default;
      box-shadow:0 20px 60px rgba(103,58,183,.3);position:relative;overflow:hidden;
    }
    #scanner-view::before{
      content:'';position:absolute;top:0;left:0;right:0;height:4px;
      background:linear-gradient(90deg,#673ab7,#0f766e,#673ab7);
      background-size:200% 100%;animation:scanner-glow 3s linear infinite;
    }
    @keyframes scanner-glow{0%{background-position:0% 0}100%{background-position:200% 0}}

    #scanner video,#scanner canvas{
      width:100% !important;height:auto !important;border-radius:12px;max-width:none !important;max-height:none !important;
    }

    .scanner-notification{
      position:absolute;top:20px;left:50%;transform:translateX(-50%);
      background:linear-gradient(135deg,#0f766e 0%,#115e59 100%);
      color:#fff;padding:15px 25px;border-radius:12px;box-shadow:0 10px 30px rgba(15,118,110,.4);
      z-index:1000001;display:flex;align-items:center;gap:12px;
      animation:notification-slide-in .5s ease-out, notification-pulse 2s infinite;
      border:2px solid rgba(187,247,208,.3);max-width:90vw;text-align:center;
    }
    @keyframes notification-slide-in{from{opacity:0;transform:translateX(-50%) translateY(-20px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
    @keyframes notification-pulse{0%,100%{box-shadow:0 10px 30px rgba(15,118,110,.4)}50%{box-shadow:0 10px 40px rgba(15,118,110,.6)}}
    .scanner-notification i{font-size:24px;color:#bbf7d0}
    .scanner-notification-content{display:flex;flex-direction:column;gap:4px}
    .scanner-notification-title{font-weight:800;font-size:16px;letter-spacing:.5px}
    .scanner-notification-subtitle{font-size:13px;opacity:.9;color:#d1fae5}
    .scanner-notification-ean{
      background:rgba(0,0,0,.3);padding:8px 15px;border-radius:8px;font-family:monospace;font-size:18px;font-weight:900;
      letter-spacing:2px;color:#bbf7d0;margin-top:5px;border:1px solid rgba(187,247,208,.2);
      text-shadow:0 0 10px rgba(187,247,208,.5);
    }

    .scanner-info{
      margin-top:20px;font-size:15px;text-align:center;color:#e5e7eb;max-width:min(720px,92vw);
      padding:15px 20px;background:rgba(31,41,55,.8);border-radius:12px;border:1px solid #374151;
      backdrop-filter:blur(10px);box-shadow:0 8px 32px rgba(0,0,0,.3);
    }
    .scanner-info-highlight{color:#bbf7d0;font-weight:700;background:rgba(15,118,110,.2);padding:2px 8px;border-radius:6px;display:inline-block;margin:0 4px}

    /* ‚úÖ Bot√£o fechar: padr√£o (EAN) */
    .scanner-close{
      position:fixed;top:20px;right:20px;
      background:rgba(220,38,38,.95);border-radius:999px;padding:12px 18px;font-size:14px;
      z-index:2147483645;border:2px solid #fca5a5;backdrop-filter:blur(10px);
      transition:all .3s ease;cursor:pointer;color:#fff;font-weight:bold;
      box-shadow:0 4px 20px rgba(220,38,38,.4);display:flex;align-items:center;gap:8px;
    }
    .scanner-close:hover{background:rgba(185,28,28,.95);transform:scale(1.05);box-shadow:0 6px 25px rgba(220,38,38,.6)}

    /* ‚úÖ NF: joga o fechar pro canto inferior direito pra N√ÉO cobrir o X do modal da licen√ßa */
    #scanner.nf-mode .scanner-close{
      top:auto !important;
      bottom:20px !important;
      right:20px !important;
      z-index:2147483644 !important; /* fica abaixo do modal */
    }

    /* ‚úÖ Modal licen√ßa sempre no topo */
    .dce-modal, .dce-dialog{z-index:2147483647 !important;position:fixed !important;pointer-events:auto !important}
    .dce-modal-backdrop{z-index:2147483646 !important;position:fixed !important;inset:0 !important}

    .scanner-paused{border-color:#0f766e !important;animation:paused-glow 2s ease-in-out infinite}
    @keyframes paused-glow{
      0%,100%{border-color:#0f766e;box-shadow:0 20px 60px rgba(15,118,110,.3)}
      50%{border-color:#10b981;box-shadow:0 20px 60px rgba(16,185,129,.5)}
    }
    .scanner-info-paused{background:rgba(15,118,110,.2) !important;border-color:#0f766e !important;color:#bbf7d0 !important}

    .mini-teste{margin-top:10px;padding:10px;border:1px dashed #444;border-radius:10px;background:#1b1b1b}
    .mini-teste .row{align-items:center}
    .mini-teste input{margin:0}
    .mini-teste button{min-width:160px}

    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;justify-content:center;align-items:center;z-index:2000}
    .modal-content{background:#1e1e1e;padding:25px;border-radius:12px;width:90%;max-width:600px;border:1px solid #444;box-shadow:0 10px 30px rgba(0,0,0,.5)}
    .modal-header{color:#f97373;font-size:1.2rem;font-weight:800;margin-bottom:15px;text-align:center}
    .modal-body{max-height:300px;overflow-y:auto;margin-bottom:20px;font-size:14px}
    .modal-item{padding:10px;border-bottom:1px solid #333;display:flex;justify-content:space-between;align-items:center;gap:10px}
    .modal-footer{text-align:center}

    footer{
      text-align:center;font-size:13px;color:#ccc;background:#2c2c2c;padding:10px 15px;border-radius:6px;margin:10px;max-width:980px;width:100%;
    }

    @media (max-width: 860px){
      .cards{grid-template-columns:1fr}
      .linha-botoes{flex-direction:column}
      .scanner-notification{top:10px;padding:12px 20px;width:95vw}
      .scanner-notification-ean{font-size:16px}
    }

    /* NF: remove caixa preta e info */
    #scanner.nf-mode #scanner-view{
      background:transparent !important;border:none !important;box-shadow:none !important;padding:0 !important;
      min-height:0 !important;height:0 !important;overflow:hidden !important;
    }
    #scanner.nf-mode #scanner-view::before{display:none !important}
    #scanner.nf-mode #scanner-info{display:none !important}
  </style>
</head>

<body>
  <div class="top-nav">
    <a href="index.html" class="back-button">
      <i class="fas fa-arrow-left"></i> Voltar √† Home
    </a>
  </div>

  <img src="logo.png" alt="Logo HS" class="logo-topo" />

  <div class="container">
    <div class="form-container">

      <div id="login" class="login-box">
        <h2>Login da Filial</h2>

        <label for="codigo-filial">C√≥digo da Filial</label>
        <input id="codigo-filial" type="text" placeholder="Ex: 293, 488, 287, 288, 761" />

        <label for="nome-conferente">Conferente</label>
        <input id="nome-conferente" type="text" placeholder="Ex: WILL" />

        <button class="btn-full" onclick="entrar()">
          <i class="fas fa-door-open"></i> Entrar
        </button>
      </div>

      <div id="principal" class="hidden">
        <div class="logout">
          <button class="btn-secundario" onclick="sair()">
            <i class="fas fa-sign-out-alt"></i> Sair
          </button>
        </div>

        <h1>Confer√™ncia de Nota Fiscal</h1>
        <div class="info-filial" id="info-filial"></div>
        <div class="info-conferente" id="info-conferente"></div>

        <label for="chave">Chave de Acesso (44 d√≠gitos)</label>
        <input id="chave" type="text" maxlength="44" placeholder="Digite ou leia o c√≥digo de barras da NF" />

        <div class="linha-botoes">
          <button onclick="abrirLeitor('NF')">
            <i class="fas fa-camera"></i> Ler Chave da NF
          </button>
          <button onclick="carregarNF()">
            <i class="fas fa-cloud-download-alt"></i> Carregar Itens da NF
          </button>
        </div>

        <div id="loading" class="loading hidden">‚è≥ Carregando itens da NF...</div>
        <div id="erro" class="erro"></div>

        <div id="painel" class="hidden">
          <div class="cards">
            <div class="card">
              <div class="titulo">Resumo da NF</div>
              <div class="muted" id="resumo-nf"></div>

              <div class="kpi"><strong>Total itens na NF</strong><span id="kpi-nf">0</span></div>
              <div class="kpi"><strong>Total escaneado</strong><span id="kpi-scan">0</span></div>
              <div class="kpi"><strong>Sync</strong><span id="kpi-sync">‚Äî</span></div>
            </div>

            <div class="card">
              <div class="titulo">Scanner de Pe√ßas</div>
              <div class="muted">
                Escaneie os EANs das etiquetas. O sistema soma autom√°tico.
                <br><small>(Sem travar c√¢mera / sem clicar para destravar)</small>
              </div>

              <div class="linha-botoes" style="margin-top:10px">
                <button class="btn-ok" onclick="abrirLeitor('EAN')">
                  <i class="fas fa-barcode"></i> Escanear EAN (Pe√ßas)
                </button>
                <button class="btn-secundario" onclick="limparScans()">
                  <i class="fas fa-eraser"></i> Zerar Scans
                </button>
              </div>

              <!-- ‚úÖ voltou: ajuste manual -->
              <div class="linha-botoes">
                <button class="btn-warn btn-full" onclick="ajusteManualPrompt()">
                  <i class="fas fa-wrench"></i> Ajustar item (manual)
                </button>
              </div>

              <div class="mini-teste">
                <div class="muted" style="margin-bottom:6px"><strong>Teste sem c√¢mera:</strong> cole um EAN e clique em Adicionar</div>
                <div id="buffer-ean" class="loading hidden" style="margin-bottom:5px">üîç Buscando dados no banco...</div>
                <div class="row" style="gap:10px">
                  <input id="ean-manual" type="text" placeholder="Cole aqui o EAN (somente n√∫meros)" />
                  <button class="btn-ok" onclick="adicionarEANManual()">
                    <i class="fas fa-plus"></i> Adicionar
                  </button>
                </div>
              </div>

              <div class="linha-botoes">
                <button class="btn-full" onclick="fazerConferencia()">
                  <i class="fas fa-clipboard-check"></i> Fazer Confer√™ncia
                </button>
                <button id="btn-enviar" class="btn-full hidden" onclick="enviarConferencia()">
                  <i class="fas fa-paper-plane"></i> Enviar Resultado
                </button>
              </div>

              <div id="msg" class="loading hidden"></div>
            </div>
          </div>

          <div class="campo-pesquisa">
            <label for="filtro">Buscar (EAN / refer√™ncia / cor / tamanho)</label>
            <input id="filtro" type="text" placeholder="Digite para filtrar..." />
          </div>

          <div class="titulo">
            Resultado da Confer√™ncia
            <small id="resumo-div"></small>
          </div>

          <div id="lista" class="lista"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="scanner">
    <button class="scanner-close" onclick="fecharLeitor()">
      <i class="fas fa-times"></i> Fechar Scanner
    </button>
    <div id="scanner-view"></div>
    <div id="scanner-info" class="scanner-info"></div>
  </div>

  <div id="modal-divergencia" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">‚ö†Ô∏è DIVERG√äNCIAS IDENTIFICADAS</div>
      <div class="modal-body" id="modal-lista"></div>
      <div class="modal-footer">
        <p style="font-size: 13px; color: #bbb; margin-bottom: 15px;">Favor fazer uma confer√™ncia dos mesmos.</p>
        <button onclick="fecharModal()">Entendido</button>
      </div>
    </div>
  </div>

  <footer>
    &copy; 2025 HS - Sistema de Confer√™ncia de Notas Fiscais.
  </footer>

  <script>
    const URL_API = "https://script.google.com/macros/s/AKfycbx1HDzA2b478DAhi5ONS6TstKieKf4lvFM9wzib9McUrdP7Z4Xwhb6SrUt5KW1YcR3x/exec";

    const filiaisValidas = ["293", "488", "287", "288", "761"];
    const nomesFiliais = { "293":"ARTUR","488":"FLORIANO","287":"JOTA","288":"PONTO","761":"MODA" };

    let filialAtual = "";
    let conferenteAtual = "";

    let cabecalhoAtual = null;
    let itensNF = [];
    let mapaScan = {};
    let termoFiltro = "";

    let scannerInstance = null;   // Dynamsoft (NF)
    let html5Scanner = null;      // Html5Qrcode (EAN)
    let modoScanner = "";

    const EAN_COOLDOWN_MS = 700;
    let ultimosEan = new Map();
    let audioCtx = null;

    let cacheInfoEAN = {};

    let syncTimer = null;
    let syncAtivo = false;
    let ultimoSyncHash = "";

    // ‚úÖ refresh do banco NF (itens) em tempo real
    let nfRefreshTimer = null;
    let ultimoHashNF = "";

    function eanPermitido_(ean13){
      // mant√©m sua regra de prefixo
      return /^7900|^7909/.test(String(ean13||""));
    }

    function bloquearBody_(on){
      document.body.style.overflow = on ? "hidden" : "";
    }

    function setMsg_(texto, ok=false){
      const el = document.getElementById("msg");
      if(!texto){
        el.classList.add("hidden");
        el.textContent = "";
        return;
      }
      el.textContent = texto;
      el.classList.remove("hidden");
      el.style.color = ok ? "#bbf7d0" : "#1a73e8";
      el.style.fontWeight = ok ? "800" : "normal";
    }

    function mostrarNotificacaoEAN(ean13) {
      if (modoScanner !== "EAN") return;

      const scannerDiv = document.getElementById("scanner");
      const notifAnterior = scannerDiv.querySelector('.scanner-notification');
      if (notifAnterior) notifAnterior.remove();

      const notificacao = document.createElement('div');
      notificacao.className = 'scanner-notification';
      notificacao.innerHTML = `
        <i class="fas fa-check-circle"></i>
        <div class="scanner-notification-content">
          <div class="scanner-notification-title">C√ìDIGO CAPTURADO!</div>
          <div class="scanner-notification-subtitle">Clique em qualquer lugar para escanear novamente</div>
          <div class="scanner-notification-ean">${ean13}</div>
        </div>
      `;
      scannerDiv.appendChild(notificacao);

      setTimeout(() => {
        if (notificacao.parentNode) {
          notificacao.style.opacity = '0';
          notificacao.style.transform = 'translateX(-50%) translateY(-20px)';
          setTimeout(() => { if (notificacao.parentNode) notificacao.remove(); }, 300);
        }
      }, 3000);
    }

    function reativarScannerEAN() {
      if (html5Scanner && modoScanner === "EAN") {
        html5Scanner.resume();

        const info = document.getElementById("scanner-info");
        info.innerHTML = `
          Aponte para o <span class="scanner-info-highlight">EAN-13</span> das pe√ßas.<br/>
          <span class="scanner-info-highlight">Sem travar</span> e com <span class="scanner-info-highlight">bipe instant√¢neo</span>.
        `;
        info.classList.remove("scanner-info-paused");

        const scannerView = document.getElementById("scanner-view");
        scannerView.classList.remove("scanner-paused");

        const notif = document.querySelector('.scanner-notification');
        if (notif) notif.remove();
      }
    }

    function entrar(){
      const f = document.getElementById("codigo-filial").value.trim();
      const nome = document.getElementById("nome-conferente").value.trim();

      if(!filiaisValidas.includes(f)){ alert("C√≥digo de filial inv√°lido."); return; }
      if(!nome){ alert("Informe o nome do conferente."); return; }

      filialAtual = f;
      conferenteAtual = nome;

      localStorage.setItem("filial_conf_nf", f);
      localStorage.setItem("conferente_conf_nf", nome);

      document.getElementById("login").classList.add("hidden");
      document.getElementById("principal").classList.remove("hidden");

      atualizarInfoTopo_();
    }

    function atualizarInfoTopo_(){
      document.getElementById("info-filial").textContent = `Filial logada: ${filialAtual} - ${nomesFiliais[filialAtual] || ""}`;
      document.getElementById("info-conferente").textContent = `Conferente: ${conferenteAtual || "‚Äî"}`;
    }

    function sair(){
      if(!confirm("Deseja sair?")) return;
      pararSync_();
      pararNFRefresh_();
      localStorage.removeItem("filial_conf_nf");
      localStorage.removeItem("conferente_conf_nf");
      location.reload();
    }

    async function carregarNF(){
      const chave = document.getElementById("chave").value.trim();
      const erro = document.getElementById("erro");
      const loading = document.getElementById("loading");
      const painel = document.getElementById("painel");

      if(chave.length !== 44){
        alert("A chave deve ter 44 d√≠gitos.");
        return;
      }

      erro.textContent = "";
      setMsg_("");
      loading.classList.remove("hidden");
      painel.classList.add("hidden");

      pararSync_();
      pararNFRefresh_();
      document.getElementById("kpi-sync").textContent = "‚Äî";

      try {
        const resp = await fetch(`${URL_API}?api=consultarConferenciaNF&filial=${encodeURIComponent(filialAtual)}&chave=${encodeURIComponent(chave)}&t=${Date.now()}`);
        const data = await resp.json();
        if(!data.success) throw new Error(data.message || "Erro ao buscar NF.");

        cabecalhoAtual = data.cabecalho;
        itensNF = data.itens || [];
        mapaScan = {}; // sempre ‚Äúzera local‚Äù -> vai vir do sync

        document.getElementById("resumo-nf").innerHTML = `
          <strong>NF:</strong> ${cabecalhoAtual.numeroNF} |
          <strong>Emitente:</strong> ${cabecalhoAtual.nomeEmitente} |
          <strong>Data:</strong> ${cabecalhoAtual.dataEmissao}
        `;

        atualizarKPIs();
        document.getElementById("painel").classList.remove("hidden");
        document.getElementById("btn-enviar").classList.add("hidden");
        render(montarListaConferencia(false));

        iniciarSync_();
        iniciarNFRefresh_();

      } catch(err) {
        erro.textContent = err.message;
      } finally {
        loading.classList.add("hidden");
      }
    }

    function atualizarKPIs(){
      let totalNF = 0;
      itensNF.forEach(i => totalNF += Number(i.quantidade || 0));

      let totalScan = 0;
      Object.values(mapaScan).forEach(v => totalScan += Number(v || 0));

      document.getElementById("kpi-nf").textContent = totalNF;
      document.getElementById("kpi-scan").textContent = totalScan;
    }

    function montarListaConferencia(jaConferido){
      const lista = [];
      const eansNaNota = new Set();

      itensNF.forEach(i => {
        const ean = String(i.ean || "").trim();
        eansNaNota.add(ean);

        const qtdScan = Number(mapaScan[ean] || 0);
        const qtdNF = Number(i.quantidade || 0);
        const diff = qtdScan - qtdNF;

        let status = "";
        if(jaConferido){
          if(diff === 0) status = "OK";
          else if(diff < 0) status = "FALTANDO";
          else status = "PASSANDO";
        }

        lista.push({
          ean,
          codigo:i.codigo, cor:i.cor, tamanho:i.tamanho,
          qtdNF, qtdScan, diff, status, tipo:"nota"
        });
      });

      Object.keys(mapaScan).forEach(ean => {
        if(!eansNaNota.has(ean)){
          const info = cacheInfoEAN[ean] || { codigo:"---", cor:"---", tamanho:"---" };
          lista.push({
            ean,
            codigo: info.codigo,
            cor: info.cor,
            tamanho: info.tamanho,
            qtdNF: 0,
            qtdScan: Number(mapaScan[ean] || 0),
            diff: Number(mapaScan[ean] || 0),
            status: jaConferido ? "EXTRA" : "",
            tipo: "extra"
          });
        }
      });

      if(termoFiltro){
        const t = termoFiltro.toLowerCase();
        return lista.filter(i =>
          String(i.ean).includes(t) ||
          String(i.codigo).toLowerCase().includes(t) ||
          String(i.cor).toLowerCase().includes(t) ||
          String(i.tamanho).toLowerCase().includes(t)
        );
      }

      return lista;
    }

    function render(lista){
      const container = document.getElementById("lista");
      container.innerHTML = "";

      let faltam = 0;
      let passam = 0;

      lista.forEach(i => {
        if(i.status === "FALTANDO") faltam++;
        if(i.status === "PASSANDO" || i.status === "EXTRA") passam++;

        const div = document.createElement("div");
        div.className = "item";

        let badgeClass = "badge";
        if(i.status === "OK") badgeClass += " ok";
        else if(i.status === "FALTANDO") badgeClass += " faltando";
        else if(i.status === "PASSANDO") badgeClass += " passando";
        else if(i.status === "EXTRA") badgeClass += " extra";

        div.innerHTML = `
          <div class="row">
            <strong>EAN: ${i.ean}</strong>
            ${i.status ? `<span class="${badgeClass}">${i.status}</span>` : ""}
          </div>
          <div class="row muted">
            <span>Ref/Cor: ${i.codigo} / ${i.cor}</span>
            <span>Tam: ${i.tamanho}</span>
            <span>NF: ${i.qtdNF}</span>
            <span>Scan: ${i.qtdScan}</span>
            <span>Dif: ${i.diff}</span>
          </div>
        `;
        container.appendChild(div);
      });

      const resumoDiv = document.getElementById("resumo-div");
      if(faltam > 0 || passam > 0){
        resumoDiv.innerHTML = `
          <span style="color:#f97373">${faltam} itens FALTANDO</span>,
          <span style="color:#43b0ff">${passam} itens PASSANDO</span>
        `;
      } else {
        resumoDiv.textContent = "";
      }
    }

    function fazerConferencia(){
      const lista = montarListaConferencia(true);
      render(lista);
      document.getElementById("btn-enviar").classList.remove("hidden");

      const divergencias = lista.filter(i => i.diff !== 0);

      if(divergencias.length > 0){
        setMsg_("");
        abrirModal(divergencias);
      } else {
        // ‚úÖ pedido: quando n√£o tiver diverg√™ncia, mostrar msg
        setMsg_("‚úÖ NF OK ‚Äî sem diverg√™ncias.", true);
      }
    }

    function abrirModal(divergencias){
      const modal = document.getElementById("modal-divergencia");
      const listaModal = document.getElementById("modal-lista");
      listaModal.innerHTML = "";

      divergencias.forEach(i => {
        const div = document.createElement("div");
        div.className = "modal-item";

        let label = "";
        let cor = "#cbd5e1";

        if(i.diff < 0){
          label = `FALTANDO: ${Math.abs(i.diff)}`;
          cor = "#f97373";
        } else {
          label = `PASSANDO: ${i.diff}`;
          cor = "#43b0ff";
        }

        div.innerHTML = `
          <span><strong>${i.codigo} / ${i.cor} / ${i.tamanho}</strong></span>
          <span style="color:${cor}; font-weight:800">${label}</span>
        `;
        listaModal.appendChild(div);
      });

      modal.style.display = "flex";
    }

    function fecharModal(){
      document.getElementById("modal-divergencia").style.display = "none";
    }

    async function limparScans(){
      if(!cabecalhoAtual) return;
      if(!confirm("Zerar TODA a contagem dessa NF (para todos os usu√°rios)?")) return;

      const chave = String(cabecalhoAtual.chaveAcesso || "").trim();
      if(!chave) return;

      try{
        const resp = await fetch(URL_API, {
          method:"POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify({ api:"zerarSyncNF", chaveAcesso: chave })
        });
        const data = await resp.json();
        if(!data.success) throw new Error(data.message || "Falha ao zerar no servidor.");
      }catch(e){
        alert("N√£o consegui zerar no servidor: " + (e.message || e));
        return;
      }

      mapaScan = {};
      atualizarKPIs();
      const jaConferido = !document.getElementById("btn-enviar").classList.contains("hidden");
      render(montarListaConferencia(jaConferido));
      puxarSyncAgora_();
      alert("Zerado (servidor + tela).");
    }

    function beepOk(){
      try{
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = "square";
        o.frequency.value = 880;
        g.gain.value = 0.08;
        o.connect(g); g.connect(audioCtx.destination);
        o.start();
        setTimeout(()=>{ o.stop(); }, 110);
      }catch(e){}
      try{ if(navigator.vibrate) navigator.vibrate(50); }catch(e){}
    }

    function isValidEAN13(ean){
      if(!/^\d{13}$/.test(ean)) return false;
      const digits = ean.split('').map(n => parseInt(n,10));
      const check = digits[12];
      let sum = 0;
      for(let i=0;i<12;i++){
        sum += digits[i] * (i%2===0 ? 1 : 3);
      }
      const calc = (10 - (sum % 10)) % 10;
      return calc === check;
    }

    function extrairEAN13DoTexto(texto){
      const only = String(texto||"").replace(/\D/g,"");
      if(only.length < 13) return "";
      for(let i=0; i<=only.length-13; i++){
        const cand = only.substring(i, i+13);
        if(isValidEAN13(cand)) return cand;
      }
      return "";
    }

    function iniciarSync_(){
      if(!cabecalhoAtual || !cabecalhoAtual.chaveAcesso) return;
      syncAtivo = true;
      ultimoSyncHash = "";
      puxarSyncAgora_();
      syncTimer = setInterval(() => { puxarSyncAgora_(); }, 1100);
    }

    function pararSync_(){
      syncAtivo = false;
      if(syncTimer){ clearInterval(syncTimer); syncTimer = null; }
      document.getElementById("kpi-sync").textContent = "‚Äî";
    }

    function _hashMapa_(obj){
      const keys = Object.keys(obj || {}).sort();
      let s = "";
      for(const k of keys){ s += k + ":" + String(obj[k]) + ";"; }
      return s;
    }

    async function puxarSyncAgora_(){
      if(!syncAtivo || !cabecalhoAtual) return;
      const chave = String(cabecalhoAtual.chaveAcesso || "").trim();
      if(!chave || chave.length !== 44) return;

      try{
        const resp = await fetch(`${URL_API}?api=sincronizarBipes&chave=${encodeURIComponent(chave)}&t=${Date.now()}`);
        const data = await resp.json();
        if(!data || !data.success) throw new Error("sync fail");

        const bipes = data.bipes || {};
        const hash = _hashMapa_(bipes);

        if(hash !== ultimoSyncHash){
          ultimoSyncHash = hash;
          mapaScan = bipes;
          atualizarKPIs();
          const jaConferido = !document.getElementById("btn-enviar").classList.contains("hidden");
          render(montarListaConferencia(jaConferido));
        }

        document.getElementById("kpi-sync").textContent = "OK";
      }catch(e){
        document.getElementById("kpi-sync").textContent = "OFF";
      }
    }

    // ‚úÖ refresh do banco (itensNF) em tempo real
    function iniciarNFRefresh_(){
      pararNFRefresh_();
      if(!cabecalhoAtual) return;
      ultimoHashNF = "";
      atualizarItensNFDoBanco_();
      nfRefreshTimer = setInterval(()=>atualizarItensNFDoBanco_(), 12000);
    }
    function pararNFRefresh_(){
      if(nfRefreshTimer){ clearInterval(nfRefreshTimer); nfRefreshTimer = null; }
    }
    function _hashItensNF_(arr){
      const norm = (arr||[]).map(i => `${String(i.ean||"").trim()}|${Number(i.quantidade||0)}|${String(i.codigo||"")}|${String(i.cor||"")}|${String(i.tamanho||"")}`);
      norm.sort();
      return norm.join(";");
    }
    async function atualizarItensNFDoBanco_(){
      try{
        if(!cabecalhoAtual || !cabecalhoAtual.chaveAcesso) return;
        const chave = String(cabecalhoAtual.chaveAcesso||"").trim();
        const resp = await fetch(`${URL_API}?api=consultarConferenciaNF&filial=${encodeURIComponent(filialAtual)}&chave=${encodeURIComponent(chave)}&t=${Date.now()}`);
        const data = await resp.json();
        if(!data || !data.success) return;

        const novosItens = data.itens || [];
        const hash = _hashItensNF_(novosItens);

        if(hash && hash !== ultimoHashNF){
          ultimoHashNF = hash;
          itensNF = novosItens;

          // atualiza cabe√ßalho se mudou algo
          cabecalhoAtual = data.cabecalho || cabecalhoAtual;

          document.getElementById("resumo-nf").innerHTML = `
            <strong>NF:</strong> ${cabecalhoAtual.numeroNF} |
            <strong>Emitente:</strong> ${cabecalhoAtual.nomeEmitente} |
            <strong>Data:</strong> ${cabecalhoAtual.dataEmissao}
          `;

          atualizarKPIs();
          const jaConferido = !document.getElementById("btn-enviar").classList.contains("hidden");
          render(montarListaConferencia(jaConferido));
        }
      }catch(e){}
    }

    function registrarEANNoServidor_(ean){
      if(!cabecalhoAtual || !cabecalhoAtual.chaveAcesso) return;

      const payload = {
        api: "registrarBipeIndividual",
        chaveAcesso: String(cabecalhoAtual.chaveAcesso || "").trim(),
        ean: String(ean || "").trim(),
        qtd: 1,
        conferente: conferenteAtual || "Usu√°rio"
      };

      fetch(URL_API, {
        method:"POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      })
      .then(r => r.json())
      .then(data => {
        if(data && data.success){
          const naNota = itensNF.some(i => String(i.ean || "") === String(ean));
          if(!naNota && !cacheInfoEAN[ean]) buscarEANNoBanco(ean);
          puxarSyncAgora_();
        }
      })
      .catch(()=>{});
    }

    async function buscarEANNoBanco(ean){
      const buffer = document.getElementById("buffer-ean");
      buffer.classList.remove("hidden");
      try {
        const resp = await fetch(URL_API, {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify({ api: "buscarInfoEAN", filial: filialAtual, eans: [ean] })
        });
        const data = await resp.json();
        if(data.success && data.itens && data.itens[ean]){
          cacheInfoEAN[ean] = data.itens[ean];
          const jaConferido = !document.getElementById("btn-enviar").classList.contains("hidden");
          render(montarListaConferencia(jaConferido));
        }
      } catch(e) {
      } finally {
        buffer.classList.add("hidden");
      }
    }

    function podeProcessarEAN_(ean){
      const now = Date.now();
      const last = ultimosEan.get(ean) || 0;
      if(now - last < EAN_COOLDOWN_MS) return false;
      ultimosEan.set(ean, now);

      if(ultimosEan.size > 200){
        for(const [k,v] of ultimosEan){
          if(now - v > 15000) ultimosEan.delete(k);
        }
      }
      return true;
    }

    async function abrirLeitor(modo){
      const scannerDiv = document.getElementById("scanner");
      const scannerView = document.getElementById("scanner-view");
      const info = document.getElementById("scanner-info");

      modoScanner = modo;

      scannerDiv.classList.remove("nf-mode","ean-mode");
      setMsg_("");

      if(modoScanner === "EAN" && !cabecalhoAtual){
        alert("Carregue a NF primeiro.");
        return;
      }

      if(modoScanner === "EAN"){
        scannerDiv.classList.add("ean-mode");
        scannerView.innerHTML = `<div class="muted" style="text-align:center;padding:10px">Iniciando c√¢mera...</div>`;
        info.innerHTML = `
          Aponte para o <span class="scanner-info-highlight">EAN-13</span> das pe√ßas.<br/>
          <span class="scanner-info-highlight">Sem travar</span> e com <span class="scanner-info-highlight">bipe instant√¢neo</span>.
        `;
        scannerDiv.style.display = "flex";
        bloquearBody_(true);
      } else {
        scannerDiv.classList.add("nf-mode");
        scannerDiv.style.display = "flex";
        bloquearBody_(true);
      }

      try{
        await pararScannerAtual_();

        if(modoScanner === "EAN"){
          await iniciarHtml5EAN_(scannerView, info);
          return;
        }

        await iniciarDynamsoftNF_(scannerView);

      }catch(ex){
        try{ await fecharLeitor(); }catch(e){}
        const msg = (ex && (ex.message || ex.toString())) || "Falha ao abrir a c√¢mera.";
        alert("Erro ao abrir leitor da NF: " + msg);
      }
    }

    async function pararScannerAtual_(){
      try{
        if(scannerInstance){
          await scannerInstance.hide().catch(()=>{});
          await scannerInstance.stop().catch(()=>{});
          await scannerInstance.destroyContext().catch(()=>{});
          scannerInstance = null;
        }
      }catch(e){}

      try{
        if(html5Scanner){
          await html5Scanner.stop().catch(()=>{});
          html5Scanner = null;
        }
      }catch(e){}
    }

    // ‚úÖ Dynamsoft NF: configura formatos + leitura √∫nica + joga chave no input
    async function iniciarDynamsoftNF_(scannerView){
      scannerInstance = await Dynamsoft.DBR.BarcodeScanner.createInstance();

      let settings = await scannerInstance.getRuntimeSettings();
      settings.barcodeFormatIds = Dynamsoft.DBR.EnumBarcodeFormat.BF_ALL;
      settings.barcodeFormatIds_2 = Dynamsoft.DBR.EnumBarcodeFormat.BF2_NULL;
      settings.expectedBarcodesCount = 1;
      await scannerInstance.updateRuntimeSettings(settings);

      const processarResultado = (results)=>{
        if(!results || !results.length) return;
        for(const r of results){
          const code = String(r.barcodeText || "").trim();
          if(!code) continue;
          const onlyNumbers = code.replace(/\D/g,'');
          if(onlyNumbers.length >= 44){
            const chave = onlyNumbers.substring(0,44);
            document.getElementById("chave").value = chave;
            beepOk();
            fecharLeitor();
            return;
          }
        }
      };

      // Prefer√™ncia: leitura ‚Äún√£o duplicada‚Äù
      scannerInstance.onUnduplicatedRead = (txt, results) => processarResultado(results);
      // fallback: frame read
      scannerInstance.onFrameRead = (results) => processarResultado(results);

      await scannerInstance.show(scannerView);
    }

    async function iniciarHtml5EAN_(scannerView, info) {
      scannerView.innerHTML = `<div id="html5-ean" style="width:min(520px, 92vw)"></div>`;
      html5Scanner = new Html5Qrcode("html5-ean");

      const config = {
        fps: 14,
        qrbox: { width: 250, height: 250 },
        experimentalFeatures: { useBarCodeDetectorIfSupported: true }
      };

      let processando = false;

      await html5Scanner.start(
        { facingMode: "environment" },
        config,
        async (decodedText) => {
          if (processando || modoScanner !== "EAN") return;

          const ean13 = extrairEAN13DoTexto(decodedText);
          if (!ean13) return;

          if (!isValidEAN13(ean13)) return;

          if (!eanPermitido_(ean13)){
            // n√£o trava: s√≥ ignora
            return;
          }

          if (!podeProcessarEAN_(ean13)) return;

          processando = true;

          try {
            beepOk();
            mostrarNotificacaoEAN(ean13);
            registrarEANNoServidor_(ean13);

            info.innerHTML = `
              <i class="fas fa-pause-circle" style="color:#0f766e; margin-right:8px;"></i>
              Scanner <span class="scanner-info-highlight">pausado</span>.<br/>
              <small>Clique em qualquer lugar para continuar escaneando.</small>
            `;
            info.classList.add("scanner-info-paused");

            await new Promise(resolve => setTimeout(resolve, 100));
            html5Scanner.pause();
            scannerView.classList.add("scanner-paused");

          } catch (e) {
            console.error("Erro no processamento:", e);
          } finally {
            processando = false;
          }
        },
        ()=>{}
      );
    }

    async function fecharLeitor() {
      try {
        if (html5Scanner) {
          await html5Scanner.stop().catch(()=>{});
          html5Scanner = null;
        }
        if (scannerInstance) {
          await scannerInstance.hide().catch(()=>{});
          await scannerInstance.stop().catch(()=>{});
          await scannerInstance.destroyContext().catch(()=>{});
          scannerInstance = null;
        }
      } catch (e) {}

      const scannerDiv = document.getElementById("scanner");
      const notificacoes = scannerDiv.querySelectorAll('.scanner-notification');
      notificacoes.forEach(n => n.remove());

      scannerDiv.classList.remove("nf-mode","ean-mode","scanner-paused");
      const scannerView = document.getElementById("scanner-view");
      scannerView.classList.remove("scanner-paused");
      const info = document.getElementById("scanner-info");
      info.classList.remove("scanner-info-paused");

      scannerDiv.style.display = "none";
      bloquearBody_(false);
      modoScanner = "";
    }

    function adicionarEANManual(){
      if (!cabecalhoAtual) { alert("Carregue a NF primeiro."); return; }

      const inp = document.getElementById("ean-manual");
      const ean13 = extrairEAN13DoTexto(inp.value || "");

      if (!ean13){
        alert("EAN inv√°lido (precisa ser EAN-13).");
        inp.value = ""; inp.focus(); return;
      }
      if (!isValidEAN13(ean13)){
        alert("EAN inv√°lido (d√≠gito verificador n√£o confere).");
        inp.value = ""; inp.focus(); return;
      }
      if (!eanPermitido_(ean13)){
        alert("EAN fora do padr√£o permitido (prefixo diferente de 7900/7909).");
        inp.value = ""; inp.focus(); return;
      }
      if (!podeProcessarEAN_(ean13)){
        alert("Aguarde um momento antes de escanear novamente.");
        inp.value = ""; return;
      }

      beepOk();
      registrarEANNoServidor_(ean13);
      inp.value = "";
      inp.focus();
    }

    // ‚úÖ ajuste manual: define TOTAL desejado por EAN (via delta no servidor)
    async function ajusteManualPrompt(){
      if(!cabecalhoAtual || !cabecalhoAtual.chaveAcesso){ alert("Carregue a NF primeiro."); return; }

      const eanBruto = prompt("Digite/cole o EAN-13 para ajustar:");
      if(!eanBruto) return;
      const ean = extrairEAN13DoTexto(eanBruto);
      if(!ean || !isValidEAN13(ean)) { alert("EAN inv√°lido."); return; }

      const atual = Number(mapaScan[ean] || 0);
      const novoStr = prompt(`Total atual no scan: ${atual}\nQual TOTAL voc√™ quer deixar para esse EAN?`, String(atual));
      if(novoStr === null) return;
      const novoTotal = Number(String(novoStr).replace(",", "."));
      if(!Number.isFinite(novoTotal) || novoTotal < 0){ alert("Valor inv√°lido."); return; }

      setMsg_("Ajustando no servidor...");
      try{
        const resp = await fetch(URL_API, {
          method:"POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify({
            api:"ajustarBipeEAN",
            chaveAcesso: String(cabecalhoAtual.chaveAcesso).trim(),
            ean,
            novoTotal,
            conferente: conferenteAtual || "Usu√°rio"
          })
        });
        const data = await resp.json();
        if(!data.success) throw new Error(data.message || "Falha ao ajustar.");

        setMsg_("‚úÖ Ajuste aplicado. Sincronizando...", true);
        puxarSyncAgora_();
      }catch(e){
        alert("Erro no ajuste manual: " + (e.message || e));
        setMsg_("");
      }
    }

    async function enviarConferencia(){
      const erro = document.getElementById("erro");
      const msg = document.getElementById("msg");
      erro.textContent = "";

      if(!cabecalhoAtual){ erro.textContent = "Nenhuma NF carregada."; return; }
      if(!confirm("Deseja enviar o resultado da confer√™ncia para o banco?")) return;

      msg.textContent = "Enviando resultado da confer√™ncia...";
      msg.classList.remove("hidden");

      const listaFinal = montarListaConferencia(true);

      const payload = {
        api: "registrarConferenciaNF",
        filialCodigo: filialAtual,
        filialNome: nomesFiliais[filialAtual] || "",
        numeroNF: cabecalhoAtual.numeroNF || "",
        chaveAcesso: cabecalhoAtual.chaveAcesso || document.getElementById("chave").value.trim(),
        dataConferencia: new Date().toISOString(),
        totalNF: Number(document.getElementById("kpi-nf").textContent || 0),
        totalScan: Number(document.getElementById("kpi-scan").textContent || 0),
        conferente: conferenteAtual || "Usu√°rio",
        itens: listaFinal.map(i => ({
          ean: i.ean,
          codigo: i.codigo,
          cor: i.cor,
          tamanho: i.tamanho,
          qtdNF: i.qtdNF,
          qtdScan: i.qtdScan,
          diff: i.diff,
          status: i.status
        }))
      };

      try{
        const resp = await fetch(URL_API, {
          method:"POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        if(!data.success) throw new Error(data.message || "Falha ao registrar confer√™ncia.");

        alert("Confer√™ncia registrada com sucesso!");
        limparTela();
      }catch(err){
        erro.textContent = "Erro ao enviar: " + (err.message || err);
      }finally{
        msg.classList.add("hidden");
      }
    }

    function limparTela(){
      pararSync_();
      pararNFRefresh_();
      cabecalhoAtual = null;
      mapaScan = {};
      itensNF = [];
      termoFiltro = "";
      cacheInfoEAN = {};
      ultimosEan.clear();

      document.getElementById("chave").value = "";
      document.getElementById("filtro").value = "";
      document.getElementById("ean-manual").value = "";

      document.getElementById("painel").classList.add("hidden");
      document.getElementById("btn-enviar").classList.add("hidden");
      document.getElementById("resumo-div").textContent = "";
      document.getElementById("lista").innerHTML = "";

      setMsg_("");
      document.getElementById("chave").focus();
    }

    window.addEventListener("load", ()=>{
      const f = localStorage.getItem("filial_conf_nf");
      const nome = localStorage.getItem("conferente_conf_nf");

      if(f && filiaisValidas.includes(f) && nome){
        filialAtual = f;
        conferenteAtual = nome;
        document.getElementById("login").classList.add("hidden");
        document.getElementById("principal").classList.remove("hidden");
        atualizarInfoTopo_();
      }

      document.getElementById("filtro").addEventListener("input", (e)=>{
        termoFiltro = e.target.value.trim();
        const jaConferido = !document.getElementById("btn-enviar").classList.contains("hidden");
        render(montarListaConferencia(jaConferido));
      });

      document.getElementById("ean-manual").addEventListener("keydown", (e)=>{
        if(e.key === "Enter"){
          e.preventDefault();
          adicionarEANManual();
        }
      });

      document.getElementById("scanner").addEventListener("click", (e) => {
        if (modoScanner === "EAN") {
          if (e.target.id === "scanner" || e.target.closest("#scanner-view")) reativarScannerEAN();
        }
      }, true);

      window.addEventListener("keydown", (e)=>{
        if(e.key === "Escape"){
          const scannerDiv = document.getElementById("scanner");
          if(scannerDiv && scannerDiv.style.display === "flex"){
            fecharLeitor();
          }
        }
      });
    });
  </script>
</body>
</html>
